<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="theme-color" content="#000000"/><link rel="icon" href="/static/images/favicon.ico"/><link rel="apple-touch-icon" href="/static/images/logo192.png"/><link rel="stylesheet" href="/static/lib/simplemde.min.css"><title>vue3-reactive源码解析 | bill-lai 的博客</title><link href="/static/css/main.e3177452.chunk.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="style_app__1yczT"><header class="style_slide__z5PNT style_slide__3Yi3e"><a href="/"><img src="/static/media/portrait.df7a5375.jpg" class="style_portrait__2GrBh" alt="portrait"/></a><div class="style_content__3GlZB"><div class="style_introduce__2UxnL"><h1><a href="/">bill-lai</a></h1><p>专注 WEB 端开发</p></div><ul class="style_navs__2yN9I"><li><a href="/">首页</a></li><li><a href="/archive">专题</a></li><li><a href="/special">归档</a></li></ul></div></header><div class="style_body__3Yz5T"><div class="style_layer__1ZQZt"><div class="style_main__XnHDF"><div> <h1 class="main-title">vue3-reactive源码解析<span class="marker">2022-02-09 22:27</span></h1><div class="marked-body"><h2 id="阅读准备">阅读准备</h2>
<p>在阅读 reactive 源码之前，我们需要知道它的特性，了解特性推荐阅读单例测试源码或者是阅读官网的 API，推荐阅读单例，在后面阅读时才能更好理解。vue中响应式数据是通过<code>Proxy</code>来实现的，可以通过我之前写的<a href="https://bill-lai.github.io/article/d6de1bf5f0382cf53f5e/">Proxy 和 Reflect</a>来了解它的特性和一些注意事项。</p>
<p>在<code>vue3</code>中使用创建<code>reactive</code>类对象一共有四种<code>api</code>，分别对应不同的功能的对象</p>
<ul>
<li><code>reactive</code>创建可深入响应的可读写对象</li>
<li><code>readonly</code>创建可深入响应的只读对象</li>
<li><code>shallowReactive</code>创建只有表层（一层）的浅可读写对象</li>
<li><code>shallowReadonly</code>创建只有表层（一层）的浅只读对象</li>
</ul>
<p>使用<code>reactive</code>和<code>readonly</code>时会自动解构对象且不包括是数组子项的<code>Ref</code>对象，无论解构有多深，而 <code>shallow</code>类的对象则不会自动解构，只有一层也不会自动解构。比如</p>
<pre><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> reactive<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> observed1 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  a<span class="token operator">:</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  b<span class="token operator">:</span> <span class="token punctuation">{</span>
    c<span class="token operator">:</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  e<span class="token operator">:</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> c<span class="token operator">:</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  d<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">const</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> observed2 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  d<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">const</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
observed2<span class="token punctuation">.</span>_a <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{</span>v<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Number 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>observed1<span class="token punctuation">.</span>a<span class="token punctuation">)</span>
<span class="token comment">// Number 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>observed1<span class="token punctuation">.</span>b<span class="token punctuation">.</span>c<span class="token punctuation">)</span>
<span class="token comment">// Number 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>observed1<span class="token punctuation">.</span>e<span class="token punctuation">.</span>c<span class="token punctuation">)</span>
<span class="token comment">// RefImpl value: Number 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>observed1<span class="token punctuation">.</span>d<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// Number 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>observed1<span class="token punctuation">.</span>d<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span>
<span class="token comment">// RefImpl value: Number 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>observed2<span class="token punctuation">.</span>d<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// Number 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>observed2<span class="token punctuation">.</span>_a<span class="token punctuation">.</span>v<span class="token punctuation">)</span>


<span class="token keyword">const</span> shallowObserved <span class="token operator">=</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  a<span class="token operator">:</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// RefImpl value: Number 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>a<span class="token punctuation">)</span>
</code></pre>
<p><code>reactive</code>深入对象内部创建子代理时遇到下面这些情况不会创建</p>
<ul>
<li>不可更改属性描述符的对象不会创建，比如调用<code>Object.prevenExtensions</code>使对象不可扩展、<code>Object.freeze</code>冻结对象，<code>Object.seal</code>封闭对象</li>
<li>在对象上声明<code>__v_skip</code>属性为<code>true</code></li>
<li>对象调用<code>vue</code>的<code>markRaw</code></li>
</ul>
<p><code>reactive</code>对象与<code>readonly</code>对象互相转换时，<code>readonly</code>对象不可转为<code>reactive</code>；<code>reactive</code>可以转为<code>readonly</code>，但是转化的对象使用<code>isReactive</code>和<code>isReadonly</code>函数调用时都是返回<code>true</code>。比如下方代码:</p>
<pre><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> reactive<span class="token punctuation">,</span> readonly<span class="token punctuation">,</span> isReactive<span class="token punctuation">,</span> isReadonly <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"vue"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> are <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> aro <span class="token operator">=</span> <span class="token function">readonly</span><span class="token punctuation">(</span>are<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>aro<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isReadonly</span><span class="token punctuation">(</span>aro<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> bre <span class="token operator">=</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token punctuation">{</span> b<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bro <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>bre<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>bro<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isReadonly</span><span class="token punctuation">(</span>bro<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="思考实现">思考实现</h2>
<p>&emsp;&emsp;如果让我们基于<code>Proxy</code>来实现<code>vue</code>的响应式数据的话，我们会怎么设计呢，如果是我会这样设计，因为是响应式的，那么我们必须知道是哪些属性被使用，在它更改时需要重新执行监听函数，我们可以把监听函数跟收集函数统一使用一个函数来执行，而收集的函数里面收集到的<code>key</code>可能是动态的，所以每次更改都要清空依赖重新收集一遍依赖，加上<code>Proxy</code>的特性所以当收集函数使用<code>get</code>获取数据时收集当前使用<code>key</code>，当外部<code>set</code>修改数据时查看当前<code>set</code>是查看<code>key</code>是否被收集，如果被收集了，则<code>set</code>之后重新触发收集函数再次收集，而<code>vue3</code>中这个收集函数就是<code>effect</code>。当然真实使用时肯定不止<code>get</code>，<code>set</code>这里为了方便理解，我们先按简单的看。逻辑如下图所示</p>
<p><img src="/article/6452d43210bfdd32fd3c/./image/realize.drawio.svg" alt="unwrap-ref.png"></p>
<p>&emsp;&emsp;为了充分覆盖用户的数据，在<code>Proxy</code>获取的数据应该始终是<code>Proxy</code>，否则当用户修改里面的子对象时无法监听，比如下方这种情况</p>
<pre><code class="language-js"><span class="token keyword">const</span> rt <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>a<span class="token operator">:</span> <span class="token punctuation">{</span>b<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 代理内部也应该将 rt.a 转化为代理</span>
<span class="token keyword">const</span> ra <span class="token operator">=</span> ra<span class="token punctuation">.</span>a
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 收集到依赖</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ra<span class="token punctuation">.</span>b<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 触发重新执行effect</span>
ra<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">4</span>
</code></pre>
<p>&emsp;&emsp;还有一个原则，就是存储到原始数据时始终不应该存储<code>Proxy</code>后的数据，否则会造成混乱。</p>
<h2 id="入口">入口</h2>
<p>&emsp;&emsp;在<code>vue3</code>中创建（除去<code>ref</code>）中创建响应式对象一共有四种方法，分别是<code>reactive</code>、<code>shallowReactive</code>、<code>readonly</code>、<code>shallowReadonly</code>这四种方法的入口源码如下</p>
<pre><code class="language-js">
<span class="token comment">// 创建reactive对象</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果reactive进入的是readonly的话直接返回，保持只读</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>target <span class="token keyword">as</span> Target<span class="token punctuation">)</span><span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token comment">// 创建reactive对象</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
    target<span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    mutableHandlers<span class="token punctuation">,</span>
    mutableCollectionHandlers<span class="token punctuation">,</span>
    reactiveMap
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// shallowReactive创建，不会自动解包，只有根级别属性才是反应式的</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> shallowReactive<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token operator">></span><span class="token punctuation">(</span>
  target<span class="token operator">:</span> <span class="token constant">T</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ShallowReactive<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
    target<span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    shallowReactiveHandlers<span class="token punctuation">,</span>
    shallowCollectionHandlers<span class="token punctuation">,</span>
    shallowReactiveMap
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建readonly代理，如果已经是reactive可以附加readonly标识</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> readonly<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token operator">></span><span class="token punctuation">(</span>
  target<span class="token operator">:</span> <span class="token constant">T</span>
<span class="token punctuation">)</span><span class="token operator">:</span> DeepReadonly<span class="token operator">&lt;</span>UnwrapNestedRefs<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">>></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
    target<span class="token punctuation">,</span>
    <span class="token boolean">true</span><span class="token punctuation">,</span>
    readonlyHandlers<span class="token punctuation">,</span>
    readonlyCollectionHandlers<span class="token punctuation">,</span>
    readonlyMap
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> shallowReadonly<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token operator">></span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> Readonly<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
    target<span class="token punctuation">,</span>
    <span class="token boolean">true</span><span class="token punctuation">,</span>
    shallowReadonlyHandlers<span class="token punctuation">,</span>
    shallowReadonlyCollectionHandlers<span class="token punctuation">,</span>
    shallowReadonlyMap
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&emsp;&emsp;在上面源码我们可以看到，这四种创建响应式对象最终都是使用<code>createReactiveObject</code>方法来实现的，只是参数不一样， 第一个参数是加工对象，第二个参数是标识只读和可读写，为<code>true</code>时为只读，第三四个参数是代理的拦截器，一个是常用类型拦截器，一个是集合类型拦截器，这里集合数据标识<code>Map</code>、<code>Set</code>、<code>WeakMap</code>、<code>WeakSet</code>为什么将他们区分实现，可以查看之前我写的<a href="https://bill-lai.github.io/article/d6de1bf5f0382cf53f5e/#%E4%BB%A3%E7%90%86%E5%85%B7%E6%9C%89%E7%A7%81%E6%9C%89%E5%B1%9E%E6%80%A7%E7%9A%84%E5%AF%B9%E8%B1%A1">代理具有内部插槽的内建对象</a>，而且集合类型是通过<code>api</code>来获取和存储数据的，并且存储时不会经过代理，代理只能拦截到获取<code>api</code>和特定的属性（如<code>size</code>）。最后一个参数就是每个代理类型<em>（是否<code>shallow（浅处理）</code>和是否只读）</em>的存储池了，里面存储了每个对象与代理的<code>map</code>关系。</p>
<p>&emsp;&emsp;我们看看四种代理类型的 Map 声明：</p>
<pre><code class="language-js"><span class="token comment">// origin与proxy的映射</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> reactiveMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token operator">&lt;</span>Target<span class="token punctuation">,</span> any<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> shallowReactiveMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token operator">&lt;</span>Target<span class="token punctuation">,</span> any<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> readonlyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token operator">&lt;</span>Target<span class="token punctuation">,</span> any<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> shallowReadonlyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token operator">&lt;</span>Target<span class="token punctuation">,</span> any<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>&emsp;&emsp;存储<code>map</code>都是用<code>WeakMap</code>当用户丢弃这个代理和代理对象时会自动进行内存回收，方便管理。<br>接下来我们看看真正的入口源码：</p>
<pre><code class="language-js"><span class="token comment">// 创建代理对象</span>
<span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
  <span class="token comment">// 要代理的数据</span>
  target<span class="token operator">:</span> Target<span class="token punctuation">,</span>
  <span class="token comment">// 是否是只读</span>
  isReadonly<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  <span class="token comment">// 基础代理器</span>
  baseHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token comment">// 集合代理器</span>
  collectionHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token comment">// 映射map</span>
  proxyMap<span class="token operator">:</span> WeakMap<span class="token operator">&lt;</span>Target<span class="token punctuation">,</span> any<span class="token operator">></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果代理的数据不是obj则直接返回原对象</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">value cannot be made reactive: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果传入的已经是代理了，而且不是readonly -> reactive的转换则直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    target<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token punctuation">(</span>isReadonly <span class="token operator">&amp;&amp;</span> target<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 查看当前origin对象之前是不是创建过当前代理，如果创建过直接返回之前缓存的代理对象</span>
  <span class="token keyword">const</span> existingProxy <span class="token operator">=</span> proxyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> existingProxy<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果当前对象无法创建代理则直接返回origin</span>
  <span class="token keyword">const</span> targetType <span class="token operator">=</span> <span class="token function">getTargetType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>targetType <span class="token operator">===</span> TargetType<span class="token punctuation">.</span><span class="token constant">INVALID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 查看当前origin type选择集合拦截器还是基础拦截器</span>
  <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>
    target<span class="token punctuation">,</span>
    targetType <span class="token operator">===</span> TargetType<span class="token punctuation">.</span><span class="token constant">COLLECTION</span> <span class="token operator">?</span> collectionHandlers <span class="token operator">:</span> baseHandlers
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 缓存</span>
  proxyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&emsp;&emsp;在<code>createReactiveObject</code>实现用到了<code>ReactiveFlags</code>，这些都是当前代理的特定标识，在后面代理具体实现中会附加上，稍后讲到具体实现时能看到，这些标识分别是：</p>
<pre><code class="language-js"><span class="token comment">// reactive 标志符常量</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> ReactiveFlags <span class="token punctuation">{</span>
  <span class="token comment">// 是否阻止成为代理属性</span>
  <span class="token constant">SKIP</span> <span class="token operator">=</span> <span class="token string">'__v_skip'</span><span class="token punctuation">,</span>
  <span class="token comment">// 是否是reactive属性</span>
  <span class="token constant">IS_REACTIVE</span> <span class="token operator">=</span> <span class="token string">'__v_isReactive'</span><span class="token punctuation">,</span>
  <span class="token comment">// 是否是readonly属性</span>
  <span class="token constant">IS_READONLY</span> <span class="token operator">=</span> <span class="token string">'__v_isReadonly'</span><span class="token punctuation">,</span>
  <span class="token comment">// mark target</span>
  <span class="token constant">RAW</span> <span class="token operator">=</span> <span class="token string">'__v_raw'</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&emsp;&emsp;创建代理对象的<code>Target</code>必须为对象，不能为基础对象，<code>reactive</code>类型可以转化为<code>readonly</code>但是不能逆转，同一个对象不会创建两次，会在<code>map</code>中查看当前对象是否已经创建，如果创建了直接返回缓存中的。我们可以看到<code>vue</code>还会给每个对象打上<code>TargetType</code>类型，如果为<code>INVALID</code>的则标识为不可创建，直接返回源对象，<code>TargetType</code>的源码如下：</p>
<pre><code class="language-js"><span class="token comment">// reactive origin类型常量</span>
<span class="token keyword">const</span> <span class="token keyword">enum</span> TargetType <span class="token punctuation">{</span>
  <span class="token comment">// 无效的 比如基础数据类型</span>
  <span class="token constant">INVALID</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token comment">// 常见的 比如object Array</span>
  <span class="token constant">COMMON</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token comment">// 集合类型比如 map set</span>
  <span class="token constant">COLLECTION</span> <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取origin 类型辅助函数</span>
<span class="token keyword">function</span> <span class="token function">targetTypeMap</span><span class="token punctuation">(</span><span class="token parameter">rawType<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>rawType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'Object'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'Array'</span><span class="token operator">:</span>
      <span class="token keyword">return</span> TargetType<span class="token punctuation">.</span><span class="token constant">COMMON</span>
    <span class="token keyword">case</span> <span class="token string">'Map'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'Set'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'WeakMap'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'WeakSet'</span><span class="token operator">:</span>
      <span class="token keyword">return</span> TargetType<span class="token punctuation">.</span><span class="token constant">COLLECTION</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> TargetType<span class="token punctuation">.</span><span class="token constant">INVALID</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> toRawType <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> unknown<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">string</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// extract "RawType" from strings like "[object RawType]"</span>
  <span class="token keyword">return</span> <span class="token function">toTypeString</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取origin的类型</span>
<span class="token keyword">function</span> <span class="token function">getTargetType</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> Target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果mark了不可reactive或者是不可扩展的直接返回无效</span>
  <span class="token keyword">return</span> value<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">SKIP</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token operator">!</span>Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token operator">?</span> TargetType<span class="token punctuation">.</span><span class="token constant">INVALID</span>
    <span class="token operator">:</span> <span class="token function">targetTypeMap</span><span class="token punctuation">(</span><span class="token function">toRawType</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&emsp;&emsp;可以看到<code>Vue</code>中的<code>Proxy</code>对象不能创建原型被冻结的对象，这个很好理解，因为<code>Vue</code>需要对<code>Target</code>代理附加很多东西，原型被冻结将会附加失败。被用户主动<code>mark</code>的对象也不能创建。<code>markRaw</code>的源码如下:</p>
<pre><code class="language-js"><span class="token comment">// 记录对象不可代理</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> markRaw<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token operator">></span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
  <span class="token function">def</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">SKIP</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> value
<span class="token punctuation">}</span>
</code></pre>
<p>&emsp;&emsp;<code>createReactiveObject</code>会根据<code>getTargetType</code>返回的数据类型来选择是使用<code>collectionHandlers</code>集合拦截器还是<code>baseHandlers</code>常用拦截器。创建完成后会将代理缓存起来，方便下次获取和查询。到这里入口就已经看完了。接下来我们看看一些辅助函数，这些函数比较简单这里就不再讲解了：</p>
<pre><code class="language-js"><span class="token comment">// 是否是reactive</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isReactive</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token comment">// 如果当前value是readonly则查看raw是不是reactive</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isReadonly</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">isReactive</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value <span class="token keyword">as</span> Target<span class="token punctuation">)</span><span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>value <span class="token keyword">as</span> Target<span class="token punctuation">)</span><span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 是否是readonly</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isReadonly</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>value <span class="token keyword">as</span> Target<span class="token punctuation">)</span><span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查看当前是否是proxy，为reactive 或readonly则为内部代理</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isProxy</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">isReactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isReadonly</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取数据原始值</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> toRaw<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">(</span>observed<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取reactive原始对象，因为可能会有 readonly(reactive({}))写法，所以需要深入获取</span>
  <span class="token keyword">const</span> raw <span class="token operator">=</span> observed <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>observed <span class="token keyword">as</span> Target<span class="token punctuation">)</span><span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span><span class="token punctuation">]</span>
  <span class="token keyword">return</span> raw <span class="token operator">?</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span> <span class="token operator">:</span> observed
<span class="token punctuation">}</span>

<span class="token comment">// 将对象转化为reactive</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> toReactive <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">unknown</span><span class="token operator">></span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token constant">T</span></span> <span class="token operator">=></span>
  <span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> value

<span class="token comment">// 对象转化为readonly</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> toReadonly <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">unknown</span><span class="token operator">></span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token constant">T</span></span> <span class="token operator">=></span>
  <span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">readonly</span><span class="token punctuation">(</span>value <span class="token keyword">as</span> Record<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">:</span> value
</code></pre>
<!-- 
&emsp;&emsp;到这里我们还没看到`Vue`为`Proxy`标记`ReactiveFlags`，不着急`ReactiveFlags`是在拦截器中声明，我们下面会讲到。 -->

<p>&emsp;&emsp;在思考实现中我们讲到<code>Proxy</code>会收集和重新调用<code>effect</code>,在<code>vue</code>中做了进一步的细分，会用枚举区分因为什么操作收集，因为什么操作重新执行，定义的常量如下</p>
<pre><code class="language-js"><span class="token comment">// 因为什么收集</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> TrackOpTypes <span class="token punctuation">{</span>
  <span class="token comment">// 如 observed.a</span>
  <span class="token constant">GET</span> <span class="token operator">=</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
  <span class="token comment">// 如 a in observed</span>
  <span class="token constant">HAS</span> <span class="token operator">=</span> <span class="token string">'has'</span><span class="token punctuation">,</span>
  <span class="token comment">// 如 Object.keys(observed)</span>
  <span class="token constant">ITERATE</span> <span class="token operator">=</span> <span class="token string">'iterate'</span>
<span class="token punctuation">}</span>

<span class="token comment">// 因为什么重新触发</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> TriggerOpTypes <span class="token punctuation">{</span>
  <span class="token comment">// 如修改 observed.a = 1</span>
  <span class="token constant">SET</span> <span class="token operator">=</span> <span class="token string">'set'</span><span class="token punctuation">,</span>
  <span class="token comment">// 如新增 observed.b = 3</span>
  <span class="token constant">ADD</span> <span class="token operator">=</span> <span class="token string">'add'</span><span class="token punctuation">,</span>
  <span class="token comment">// 如 delete observed.a</span>
  <span class="token constant">DELETE</span> <span class="token operator">=</span> <span class="token string">'delete'</span><span class="token punctuation">,</span>
  <span class="token comment">// 在集合时使用 如map.clear()</span>
  <span class="token constant">CLEAR</span> <span class="token operator">=</span> <span class="token string">'clear'</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&emsp;&emsp;在<code>vue</code>中收集依赖统一使用<code>track</code>函数，重新触发<code>effect</code>是统一使用<code>trigger</code>函数，<code>track</code>和<code>trigger</code>除了收集操作枚举外还需要传入<code>key</code>，操作什么<code>key</code>引起的收集和触发，如果是因为<code>ownKey</code>（如<code>Object.key(...)</code>）引起的收集会使用一个内置的常量<code>ITERATE_KEY</code>替代<code>key</code>，关于<code>track</code>和<code>trigger</code>里面具体实现我们讲到<code>effect</code>章节时再讲解，这里主要将代理的实现，使用方式如下：</p>
<pre><code class="language-js"><span class="token comment">// 在vue中除了`Map`的`keys`，其他迭代的都用这个symbol来代替key，</span>
<span class="token keyword">const</span> <span class="token constant">ITERATE_KEY</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>__DEV__ <span class="token operator">?</span> <span class="token string">"iterate"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 收集什么变量，什么操作，收集到什么key</span>
<span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">ITERATE</span><span class="token punctuation">,</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">HAS</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 什么变量引起触发，什么操作，变量什么key引起触发，新值、旧值（如果有）</span>
<span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">ADD</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="常用拦截器">常用拦截器</h2>
<p>&emsp;&emsp;在上面中我们看到常用拦截器对象有四种分别是<code>mutableHandlers</code>、<code>readonlyHandlers</code>、<code>shallowReactiveHandlers</code>、<code>shallowReadonlyHandlers</code>分别对应<code>reactive</code>、<code>readonly</code>、<code>shallowReactive</code>、<code>shallowReadonly</code>类型的代理，接下来我们看看源码实现：</p>
<pre><code class="language-js"><span class="token comment">// 创建get handler</span>
<span class="token keyword">const</span> get <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 创shallow的 get handler</span>
<span class="token keyword">const</span> shallowGet <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 创建readonly的 get Handler</span>
<span class="token keyword">const</span> readonlyGet <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 创建shallowReadonly的 get handler</span>
<span class="token keyword">const</span> shallowReadonlyGet <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> set <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> shallowSet <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// reactive拦截器</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> mutableHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>object<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  get<span class="token punctuation">,</span>
  set<span class="token punctuation">,</span>
  deleteProperty<span class="token punctuation">,</span>
  has<span class="token punctuation">,</span>
  ownKeys<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// readonly拦截器</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> readonlyHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>object<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  get<span class="token operator">:</span> readonlyGet<span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Set operation on key "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" failed: target is readonly.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        target
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Delete operation on key "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" failed: target is readonly.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        target
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// shallow reactive拦截器</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> shallowReactiveHandlers <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">extend</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  mutableHandlers<span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    get<span class="token operator">:</span> shallowGet<span class="token punctuation">,</span>
    set<span class="token operator">:</span> shallowSet<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> shallowReadonlyHandlers <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">extend</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  readonlyHandlers<span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    get<span class="token operator">:</span> shallowReadonlyGet<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&emsp;&emsp;拦截器的<code>get</code>、<code>set</code>都是由<code>createGetter</code>、<code>createSetter</code>创建的，只是参数差异，在<code>createGetter</code>函数中第一个参数标识是否只读，第二个参数标识是否<code>shallow</code>，<code>createSetter</code>不带是否只读因为，只读的<code>Proxy</code>不能<code>set</code>，只需要提示不能更改，同理<code>has</code>拦截器也是没必要添加。可能你会想只读的<code>proxy</code>按理来说也不需要<code>get</code>因为对象不会更改，也就不需要收集数据，对了一半，<code>get</code>中确实不会收集，但是<code>vue</code>中代理不仅需要在<code>get</code>拦截器上收集数据而且需要附加<code>Flags</code>和创建子对象<code>proxy</code><em>（如果不是<code>shallow</code>的话）</em>。</p>
<p>&emsp;&emsp;在上面每个函数前都添加了<code>/*#__PURE__*/</code>这段注释的作用就是提示打包器这些变量时纯的，当没有使用到这些变量时可以剔除，减小打包后包的大小。</p>
<h3 id="get-拦截器">get 拦截器</h3>
<p>&emsp;&emsp;我们在思考实现中提到<code>get</code>拦截器大概职责是在<code>effect</code>时收集依赖，除此之外我们还需要保证<code>Proxy get</code>获取到的都是<code>proxy</code>，因为<code>Proxy</code>只是代理当前对象，子对象也需要深入创建，比如<code>const oa = reactive({a: { b: 2 }})</code>需要保证<code>oa.a</code>获取到的也是代理，接下来我们看<code>createGetter</code>源码：</p>
<pre><code class="language-js"><span class="token comment">// 不track收集和创建代理的的keys 包括原型，ref标识 vue标识</span>
<span class="token keyword">const</span> isNonTrackableKeys <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">makeMap</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__proto__,__v_isRef,__isVue</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

<span class="token comment">// 获取所有内置的Symbol</span>
<span class="token keyword">const</span> builtInSymbols <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>
  Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>Symbol<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">(</span>Symbol <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isSymbol<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment">// 创建get handler</span>
<span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token parameter">isReadonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> Target<span class="token punctuation">,</span> key<span class="token operator">:</span> string <span class="token operator">|</span> symbol<span class="token punctuation">,</span> receiver<span class="token operator">:</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 附加flags </span>
    <span class="token comment">// 获取是否是获取当前是否是reactive | readonly</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">!</span>isReadonly
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> isReadonly
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token comment">// 如果是获取源对象，通过代理和源数据WeakMap获取是否有被创建过</span>
      key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span> <span class="token operator">&amp;&amp;</span>
      receiver <span class="token operator">===</span>
        <span class="token punctuation">(</span>isReadonly
          <span class="token operator">?</span> shallow
            <span class="token operator">?</span> shallowReadonlyMap
            <span class="token operator">:</span> readonlyMap
          <span class="token operator">:</span> shallow
          <span class="token operator">?</span> shallowReactiveMap
          <span class="token operator">:</span> reactiveMap
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 直接返回被代理对象</span>
      <span class="token keyword">return</span> target
    <span class="token punctuation">}</span>

    <span class="token comment">// 是否是数组</span>
    <span class="token keyword">const</span> targetIsArray <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>

    <span class="token comment">// 如果当前数据是数组，而且是访问需要改造器后使用的，则使用改造器访问</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadonly <span class="token operator">&amp;&amp;</span> targetIsArray <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>arrayInstrumentations<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arrayInstrumentations<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>

    <span class="token comment">// 如果当前key是内置symbol key或者是不需要处理的key则直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSymbol</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">?</span> builtInSymbols<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">isNonTrackableKeys</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果不是只读的则track收集</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// shallow类直接返回，不需要神UR创建</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shallow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 是否应该解包ref，如果是不是数组或者是数组但是访问非int key则应该解包</span>
      <span class="token keyword">const</span> shouldUnwrap <span class="token operator">=</span> <span class="token operator">!</span>targetIsArray <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isIntegerKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      <span class="token keyword">return</span> shouldUnwrap <span class="token operator">?</span> res<span class="token punctuation">.</span>value <span class="token operator">:</span> res
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取时才创建相对应类型的代理，将访问值也转化为reactive</span>
      <span class="token keyword">return</span> isReadonly <span class="token operator">?</span> <span class="token function">readonly</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> res
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&emsp;&emsp;<code>createGetter</code>采用闭包包裹当前代理类型，当使用特定<code>Flag</code>属性获取时可以方便的返回当前代理的类型。当获取<code>Proxy</code>代理前数据时必须是已加是加工为代理的对象才能获取。</p>
<p>&emsp;&emsp;当代理类型是只读时是不会<code>track（收集）</code>依赖的，因为只读代理不会更改，收集没意义。如果是<code>shallow</code>的代理收集后则直接返回结果，因为只浅代理，只创建一层代理，如果不是<code>shallow</code>并且子属性是对象的话就动态创建当前类型的子对象代理。</p>
<p>&emsp;&emsp;<code>vue</code>的代理深创建子对象<code>proxy</code>时是使用时才创建，比如<code>const ra = readonly({a: {b: 2}})</code>使用这段代码时会创建外层<code>{a: ...}</code>代理，<code>{b: 2}</code>这层并不会马上创建，而是当你使用<code>ra.b</code>时会在<code>get</code>拦截器中创建。</p>
<p>&emsp;&emsp;<code>vue</code>中有一些保留属性是不会收集和创建子代理的例如<code>__proto__（原型）</code>,<code>__v_isRef（是否是ref）</code>,<code>__isVue（是否是vue）</code>。</p>
<p>&emsp;&emsp;除此之外还有一些系统自带的<code>Symbol</code>也不会处理，比如<code>Symbol.toStringTag</code>、<code>Symbol.iterator</code>，为什么这里不需要收集呢，因为这里在实现时如果用到代理对象也会被收集到，而比如下面这段代码中，在具体的<code>Symbol</code>执行时也是在<code>effect</code>函数内，也会被收集到，而数组内也是通过下标来<code>get</code>也会收集到具体的<code>index</code>。</p>
<pre><code class="language-js"><span class="token keyword">const</span> pig <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'猪'</span><span class="token punctuation">,</span>
  <span class="token keyword">get</span> <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 经过[Symbol.toStringTag]函数收集到name属性依赖</span>
  pig<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
pig<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'佩奇'</span>
</code></pre>
<p>&emsp;&emsp;当获取到的数据是<code>ref</code>数据时如果不是数组子项的话代理还会自动解包。不知道为啥设计成数组子项不自动解包，我猜测是因为防止<code>reactive([1, ref(2)])</code>使用时都是数字造成混乱。</p>
<h4 id="array-改造器">Array 改造器</h4>
<p>&emsp;&emsp;当代理对象是<code>Array</code>时还需要还需要对一些的<code>api</code>做特殊处理，因为数组通过一些<code>api</code>获取会引发混乱，当用户使用<code>indexOf</code>、<code>lastIndexOf</code>、<code>includes</code>时因为底层是通过<code>this[index]</code>来获取的，<code>this</code>就是<code>proxy</code>，在<code>vue</code>中如果当前子项是对象会转化为代理，就会造成通过原始对象找不到在数组中的位置，比如没处理的话下方代码会出现这种情况</p>
<pre><code class="language-js"><span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span>target<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// -1, 因为比对的是 reactive(target) === target</span>
observed<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&emsp;&emsp;在通过<code>push</code>、<code>pop</code>、<code>unshift</code>、<code>splice</code>写入和删除时底层会获取当前数组的<code>length</code>属性，如果在<code>effect</code>中使用时自然也会收集这个属性的依赖，当使用这些<code>api</code>是也会更改<code>length</code>，这时容易造成死循环，所以这些方法也需要特殊处理，比如没处理的话下方代码会出现这种情况</p>
<pre><code class="language-js"><span class="token keyword">const</span> observed<span class="token operator">:</span> number<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// e1: 采集到length依赖，并更改length</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  observed<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// e2: 采集到length依赖，并更改length，e1依赖length收到触发重新执行</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  observed<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [ 1, 2, 1 ]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&emsp;&emsp;下面我们看看<code>Array</code>改造器源码</p>
<pre><code class="language-js"><span class="token comment">// 数组的函数改造器</span>
<span class="token keyword">const</span> arrayInstrumentations <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createArrayInstrumentations</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">createArrayInstrumentations</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> instrumentations<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> Function<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// 需要对比获取源数据来比对的api</span>
  <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'includes'</span><span class="token punctuation">,</span> <span class="token string">'indexOf'</span><span class="token punctuation">,</span> <span class="token string">'lastIndexOf'</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    instrumentations<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> unknown<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> unknown<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取源数组</span>
      <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token keyword">as</span> any
      <span class="token comment">// 因为不通过代理获取，所以需要手动track收集每个子项</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">track</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 获取结果，如果获取不到结果，则将传入（可能传入代理）转换为源数据再次获取</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> arr<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> res <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> arr<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>toRaw<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 为了某些情况会无限循环，对arry的length会改变的阻止收集</span>
  <span class="token comment">// 属于对数组的更改，但是写在effect时互相引用时会容易造成无限循环</span>
  <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token string">'pop'</span><span class="token punctuation">,</span> <span class="token string">'shift'</span><span class="token punctuation">,</span> <span class="token string">'unshift'</span><span class="token punctuation">,</span> <span class="token string">'splice'</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    instrumentations<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> unknown<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> unknown<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 暂停收集</span>
      <span class="token function">pauseTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 通过源数组更改，不走代理</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
      <span class="token comment">// 恢复收集</span>
      <span class="token function">resetTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> res
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> instrumentations
<span class="token punctuation">}</span>
</code></pre>
<p>&emsp;&emsp;为了确保<code>indexOf</code>、<code>includes</code>、<code>lastIndexOf</code>等 api 能够获取到正确结果会将代理转化为<code>Target</code>对象，<code>api</code>传入对象先查找，如果查找不到再讲传入数据转化为<code>raw</code>查找比对。<code>push</code>, <code>pop</code>, <code>shift</code>, <code>unshift</code>, <code>splice</code>等 api 会在调用时暂停收集，因为他们本身也是更改数据，不用收集。</p>
<p>&emsp;&emsp;<code>track</code>采用栈的方式管理，恢复是恢复上一次的状态，我们看一下源码</p>
<pre><code class="language-js"><span class="token comment">// 当前是否开启跟踪</span>
<span class="token keyword">let</span> shouldTrack <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token comment">// 跟踪栈</span>
<span class="token keyword">const</span> trackStack<span class="token operator">:</span> boolean<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 暂停跟踪</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pauseTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  trackStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>shouldTrack<span class="token punctuation">)</span><span class="token punctuation">;</span>
  shouldTrack <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 启用跟踪</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">enableTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  trackStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>shouldTrack<span class="token punctuation">)</span><span class="token punctuation">;</span>
  shouldTrack <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 恢复上一次跟踪，如果没有上一次默认为true</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resetTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> last <span class="token operator">=</span> trackStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  shouldTrack <span class="token operator">=</span> last <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> last<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&emsp;&emsp;到这里<code>get</code>拦截器就看完了，但是没有看到与<code>effect</code>关联的部分，都是统一<code>track</code>出去的，可以猜测到区分是否在<code>effect</code>中<code>get</code>应该是在<code>effect</code>这个函数中实现的，这个我们后面再讲。</p>
<h3 id="set-拦截器和-delete-拦截器">set 拦截器和 delete 拦截器</h3>
<p>&emsp;&emsp;在思考实现时我们说到<code>set</code>拦截器主要职责是重新触发<code>effect</code>的执行，在<code>vue</code>中是使用<code>trigger</code>这个函数来实现的，<code>delete</code>拦截器也是属于修改同样的职责，接下来我们看看<code>createSetter</code>和<code>deleteProperty</code>函数源码：</p>
<pre><code class="language-js"><span class="token comment">// 创建set 拦截器</span>
<span class="token keyword">function</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token parameter">shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span>
    <span class="token parameter">target<span class="token operator">:</span> object<span class="token punctuation">,</span>
    key<span class="token operator">:</span> string <span class="token operator">|</span> symbol<span class="token punctuation">,</span>
    value<span class="token operator">:</span> unknown<span class="token punctuation">,</span>
    receiver<span class="token operator">:</span> object</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
    <span class="token comment">// 获取旧数据</span>
    <span class="token keyword">let</span> oldValue <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token comment">// 如果当前不是shallow并且不是只读的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isReadonly</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取target属性，如reacitve(ref(1))获取回来就是ref(1)</span>
      value <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      oldValue <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span>
      <span class="token comment">// 并且target不是数组并且旧数据是ref,新数据不是则直接赋值value</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isRef</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldValue<span class="token punctuation">.</span>value <span class="token operator">=</span> value
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 查看当前更新key是否存在</span>
    <span class="token keyword">const</span> hadKey <span class="token operator">=</span>
      <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isIntegerKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token function">Number</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&lt;</span> target<span class="token punctuation">.</span>length
        <span class="token operator">:</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
    <span class="token comment">// 如果是通过原型链触发的修改，则不trigger</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">===</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 查看是否存在，存在是否修改，再触发trigger</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">ADD</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// del 代理器</span>
<span class="token keyword">function</span> <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> object<span class="token punctuation">,</span> key<span class="token operator">:</span> string <span class="token operator">|</span> symbol</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hadKey <span class="token operator">=</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&amp;&amp;</span> hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre>
<p>&emsp;&emsp;<code>set</code>和<code>delete</code>拦截器相对于<code>get</code>拦截器就简单很多了，<code>set</code>和<code>delete</code>拦截器是可读写代理进入的，主要是修改，新增还是删除属性，当<code>trigger</code>时把具体细节传出。<code>set</code>还会自动解包<code>ref</code>并赋值。</p>
<p>&emsp;&emsp;<code>set</code>时如果是<code>shallow</code>或者<code>readonly</code>类型时不做任何处理，直接保持原样设置。如果<code>Target</code>不是数组，旧值是<code>ref</code>新值不是，则直接更新旧值<code>ref</code>的<code>value</code>，这里为什么不用<code>trigger</code>直接返回，这是是因为<code>ref</code>里面已经<code>trigger</code>了，关于<code>ref</code>的实现我们下一章再讲。</p>
<p>&emsp;&emsp;注意：<b>如果是数组，不管是不是下标属性，都是直接赋值，不会解包</b>。上面<code>get</code>拦截器解包逻辑不太一样，<code>get</code>拦截器中如果是数组，非下标会解包，而<code>set</code>拦截器不管是不是下标都不会解包，也就是说会出现下面这种情况，使用感觉不出来，但是还是要注意一下。</p>
<pre><code class="language-js"><span class="token keyword">const</span> observed1 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token keyword">as</span> any<span class="token punctuation">)</span>
observed1<span class="token punctuation">.</span>_a <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment">// observed._a 时会自动解包 返回2 实际上存储的是 ref(2)</span>
observed1<span class="token punctuation">.</span>_a <span class="token operator">=</span> <span class="token number">4</span>
<span class="token comment">// observed._a 返回4 实际上存储的是4</span>

<span class="token keyword">const</span> observed2 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> any<span class="token punctuation">)</span>
observed2<span class="token punctuation">.</span>_a <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment">// observed._a 时会自动解包 返回2 实际上存储的是 ref(2)</span>
observed2<span class="token punctuation">.</span>_a <span class="token operator">=</span> <span class="token number">4</span>
<span class="token comment">// observed._a 时会自动解包 返回4 实际上存储的是 ref(4)</span>
</code></pre>
<p>&emsp;&emsp;上面有段<code>target === toRaw(receiver)</code>来区分是否是原型上触发的判断，它为什么能区分出是否是原型呢，因为在<code>set</code>拦截器中第四个参数是指向当前操作者的<code>this</code>的，假如代理是附加在某个对象的原型上，那么指向的就是这个对象而不是代理。</p>
<h3 id="has-拦截器和-ownkeys-拦截器">has 拦截器和 ownKeys 拦截器</h3>
<p>&emsp;&emsp;<code>has</code>拦截器和<code>ownKeys</code>拦截器主要职责也是<code>track</code>，告诉<code>vue</code>依赖了哪些属性，与<code>get</code>拦截器一样内置的<code>Symbol</code>不做收集。当<code>Target</code>是数组时触发的<code>ownKeys</code>拦截器会将当前收集的 key 当做是<code>length</code>属性变化，这是因为用户可能在<code>effect</code>中使用<code>array.length</code>和<code>for (const atom of array)</code>，可以统一使用<code>length</code>一个属性来标识，这样当<code>length</code>改变时统一通知就可以了，如果<code>for (const atom of array)</code>使用<code>ITERATE_KEY</code>会触发两次，一次时<code>length</code>修改，一次时<code>ITERATE_KEY</code>修改。</p>
<pre><code class="language-js"><span class="token comment">// has 拦截器</span>
<span class="token keyword">function</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> object<span class="token punctuation">,</span> key<span class="token operator">:</span> string <span class="token operator">|</span> symbol</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 查看是否是内置的symbol如果是则不track</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSymbol</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>builtInSymbols<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">HAS</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// getOwnPropertyNames getOwnPropertySymbols keys 拦截器</span>
<span class="token keyword">function</span> <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> object</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span>string <span class="token operator">|</span> symbol<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">ITERATE</span><span class="token punctuation">,</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"length"</span> <span class="token operator">:</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="集合拦截器">集合拦截器</h2>
<p>&emsp;&emsp;在上面我们讲到因为<code>Proxy</code><a href="https://bill-lai.github.io/article/d6de1bf5f0382cf53f5e/#%E4%BB%A3%E7%90%86%E5%85%B7%E6%9C%89%E7%A7%81%E6%9C%89%E5%B1%9E%E6%80%A7%E7%9A%84%E5%AF%B9%E8%B1%A1">代理具有内部插槽的内建对象</a>时和集合获取和存储数据时的限制，所以必须将拦截器与普通对象区分出来。如果是你你会怎么实现呢？</p>
<p>&emsp;&emsp;其实在上面代理<code>Array</code>时已经有例子了，既然只能拦截到方法和属性，那么我们就通过改写集合<code>Proxy</code>上的方法和属性来实现就行了，下面我们列出集合上的所有的方法和属性，并标注我们需要做的事情。</p>
<table>
<thead>
<tr>
<th>方法和属性</th>
<th>Map</th>
<th>WeakMap</th>
<th>Set</th>
<th>WeakSet</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>get</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
<td>N</td>
<td><code>track</code>，类型：<code>GET</code>，<code>key</code>：用户传入</td>
</tr>
<tr>
<td>size</td>
<td>Y</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td><code>track</code>，类型：<code>ITERATE</code>，<code>key</code>：<code>ITERATE_KEY</code></td>
</tr>
<tr>
<td>has</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td><code>track</code>，类型：<code>HAS</code>，<code>key</code>：用户传入</td>
</tr>
<tr>
<td>add</td>
<td>N</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
<td><code>trigger</code>，类型: <code>ADD</code>，<code>key</code>：用户传入<em>（<code>set</code>中<code>key</code>就是<code>value</code>）</em></td>
</tr>
<tr>
<td>set</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
<td>N</td>
<td><code>trigger</code>，类型: <code>SET</code>或<code>ADD</code>，<code>key</code>：用户传入</td>
</tr>
<tr>
<td>delete</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td><code>trigger</code>，类型: <code>DELETE</code>，<code>key</code>：用户传入</td>
</tr>
<tr>
<td>clear</td>
<td>Y</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td><code>trigger</code>，类型: <code>CLEAR</code>，<code>key</code>：<code>undefined</code></td>
</tr>
<tr>
<td>forEach</td>
<td>Y</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td><code>track</code>，类型：<code>ITERATE</code>，<code>key</code>：<code>ITERATE_KEY</code></td>
</tr>
<tr>
<td>keys</td>
<td>Y</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td><code>track</code>，类型：<code>ITERATE</code>，<code>key</code>：<code>MAP_KEY_ITERATE_KEY</code></td>
</tr>
<tr>
<td>values</td>
<td>Y</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td><code>track</code>，类型：<code>ITERATE</code>，<code>key</code>：<code>ITERATE_KEY</code></td>
</tr>
<tr>
<td>entries</td>
<td>Y</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td><code>track</code>，类型：<code>ITERATE</code>，<code>key</code>：<code>ITERATE_KEY</code></td>
</tr>
<tr>
<td>Symbol.iterator</td>
<td>Y</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td><code>track</code>，类型：<code>ITERATE</code>，<code>key</code>：<code>ITERATE_KEY</code></td>
</tr>
</tbody></table>
<p>&emsp;&emsp;在上面中我们看到常用拦截器有四种分别是<code>mutableCollectionHandlers</code>、<code>readonlyCollectionHandlers</code>、<code>shallowCollectionHandlers</code>、<code>shallowReadonlyCollectionHandlers</code>分别对应<code>reactive</code>、<code>readonly</code>、<code>shallowReactive</code>、<code>shallowReadonly</code>集合代理类型接下来我们看看源码实现：</p>
<pre><code class="language-js"><span class="token comment">// 创建集合get拦截器，附加flags，和改造api</span>
<span class="token keyword">function</span> <span class="token function">createInstrumentationGetter</span><span class="token punctuation">(</span><span class="token parameter">isReadonly<span class="token operator">:</span> boolean<span class="token punctuation">,</span> shallow<span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取各个版本的修改器</span>
  <span class="token keyword">const</span> instrumentations <span class="token operator">=</span> shallow
    <span class="token operator">?</span> isReadonly
      <span class="token operator">?</span> shallowReadonlyInstrumentations
      <span class="token operator">:</span> shallowInstrumentations
    <span class="token operator">:</span> isReadonly
    <span class="token operator">?</span> readonlyInstrumentations
    <span class="token operator">:</span> mutableInstrumentations<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token parameter">target<span class="token operator">:</span> CollectionTypes<span class="token punctuation">,</span>
    key<span class="token operator">:</span> string <span class="token operator">|</span> symbol<span class="token punctuation">,</span>
    receiver<span class="token operator">:</span> CollectionTypes</span>
  <span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">!</span>isReadonly<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> isReadonly<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用拦截器返回用户使用函数</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
      <span class="token function">hasOwn</span><span class="token punctuation">(</span>instrumentations<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key <span class="token keyword">in</span> target
        <span class="token operator">?</span> instrumentations
        <span class="token operator">:</span> target<span class="token punctuation">,</span>
      key<span class="token punctuation">,</span>
      receiver
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> mutableCollectionHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>CollectionTypes<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  get<span class="token operator">:</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createInstrumentationGetter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> shallowCollectionHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>CollectionTypes<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  get<span class="token operator">:</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createInstrumentationGetter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> readonlyCollectionHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>CollectionTypes<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  get<span class="token operator">:</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createInstrumentationGetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> shallowReadonlyCollectionHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>CollectionTypes<span class="token operator">></span> <span class="token operator">=</span>
  <span class="token punctuation">{</span>
    get<span class="token operator">:</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createInstrumentationGetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>&emsp;&emsp;和我们猜想一样，<code>vue</code>只代理了集合的<code>get</code>，因为无法拦截<code>set</code>，所以通过修改方法和属性可以将我们需要做的操作附加上去。通过闭包将是否只读，是否是<code>shallow</code>缓存，并生成相对应的修改器。</p>
<p>&emsp;&emsp;跟常用拦截器一样也会为集合<code>Proxy</code>附加上各个<code>flags</code>属性。当获取某个属性时，如果这个属性是在修改器对象上，并且也在当前集合上，那么就会从修改器中获取这个方法或者属性返回。为什么还要获取是否在是否在集合上呢，因为修改器是通过<code>Proxy</code>类型分类的，而不是通过集合类型分类的，那么修改器中可能会同时存在<code>add</code>、<code>set</code>，如果不判断一遍是否存在集合上那么<code>map.add</code>也会调用到修改器中的<code>add</code>方法。接下来我们看看创建修改器的具体实现。</p>
<pre><code class="language-js"><span class="token comment">// 只读版本修改方法，只弹出警告</span>
<span class="token keyword">function</span> <span class="token function">createReadonlyMethod</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token operator">:</span> TriggerOpTypes</span><span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> CollectionTypes<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> unknown<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">on key "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" </span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">capitalize</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> operation </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">failed: target is readonly.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> type <span class="token operator">===</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">DELETE</span> <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建各个版本的拦截处理器</span>
<span class="token keyword">function</span> <span class="token function">createInstrumentations</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mutableInstrumentations<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> Function<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> MapTypes<span class="token punctuation">,</span> key<span class="token operator">:</span> unknown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">as</span> unknown <span class="token keyword">as</span> IterableCollections<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    has<span class="token punctuation">,</span>
    add<span class="token punctuation">,</span>
    set<span class="token punctuation">,</span>
    <span class="token keyword">delete</span><span class="token operator">:</span> deleteEntry<span class="token punctuation">,</span>
    clear<span class="token punctuation">,</span>
    forEach<span class="token operator">:</span> <span class="token function">createForEach</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> shallowInstrumentations<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> Function<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> MapTypes<span class="token punctuation">,</span> key<span class="token operator">:</span> unknown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">as</span> unknown <span class="token keyword">as</span> IterableCollections<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    has<span class="token punctuation">,</span>
    add<span class="token punctuation">,</span>
    set<span class="token punctuation">,</span>
    <span class="token keyword">delete</span><span class="token operator">:</span> deleteEntry<span class="token punctuation">,</span>
    clear<span class="token punctuation">,</span>
    forEach<span class="token operator">:</span> <span class="token function">createForEach</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> readonlyInstrumentations<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> Function<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> MapTypes<span class="token punctuation">,</span> key<span class="token operator">:</span> unknown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">as</span> unknown <span class="token keyword">as</span> IterableCollections<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> MapTypes<span class="token punctuation">,</span> key<span class="token operator">:</span> unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    add<span class="token operator">:</span> <span class="token function">createReadonlyMethod</span><span class="token punctuation">(</span>TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">ADD</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    set<span class="token operator">:</span> <span class="token function">createReadonlyMethod</span><span class="token punctuation">(</span>TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">delete</span><span class="token operator">:</span> <span class="token function">createReadonlyMethod</span><span class="token punctuation">(</span>TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    clear<span class="token operator">:</span> <span class="token function">createReadonlyMethod</span><span class="token punctuation">(</span>TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">CLEAR</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    forEach<span class="token operator">:</span> <span class="token function">createForEach</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> shallowReadonlyInstrumentations<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> Function<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> MapTypes<span class="token punctuation">,</span> key<span class="token operator">:</span> unknown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">as</span> unknown <span class="token keyword">as</span> IterableCollections<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> MapTypes<span class="token punctuation">,</span> key<span class="token operator">:</span> unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    add<span class="token operator">:</span> <span class="token function">createReadonlyMethod</span><span class="token punctuation">(</span>TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">ADD</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    set<span class="token operator">:</span> <span class="token function">createReadonlyMethod</span><span class="token punctuation">(</span>TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">delete</span><span class="token operator">:</span> <span class="token function">createReadonlyMethod</span><span class="token punctuation">(</span>TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    clear<span class="token operator">:</span> <span class="token function">createReadonlyMethod</span><span class="token punctuation">(</span>TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">CLEAR</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    forEach<span class="token operator">:</span> <span class="token function">createForEach</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 各个迭代器拦截器</span>
  <span class="token keyword">const</span> iteratorMethods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'keys'</span><span class="token punctuation">,</span> <span class="token string">'values'</span><span class="token punctuation">,</span> <span class="token string">'entries'</span><span class="token punctuation">,</span> Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span>
  iteratorMethods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">method</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    mutableInstrumentations<span class="token punctuation">[</span>method <span class="token keyword">as</span> string<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createIterableMethod</span><span class="token punctuation">(</span>
      method<span class="token punctuation">,</span>
      <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token boolean">false</span>
    <span class="token punctuation">)</span>
    readonlyInstrumentations<span class="token punctuation">[</span>method <span class="token keyword">as</span> string<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createIterableMethod</span><span class="token punctuation">(</span>
      method<span class="token punctuation">,</span>
      <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token boolean">false</span>
    <span class="token punctuation">)</span>
    shallowInstrumentations<span class="token punctuation">[</span>method <span class="token keyword">as</span> string<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createIterableMethod</span><span class="token punctuation">(</span>
      method<span class="token punctuation">,</span>
      <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token boolean">true</span>
    <span class="token punctuation">)</span>
    shallowReadonlyInstrumentations<span class="token punctuation">[</span>method <span class="token keyword">as</span> string<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createIterableMethod</span><span class="token punctuation">(</span>
      method<span class="token punctuation">,</span>
      <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token boolean">true</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    mutableInstrumentations<span class="token punctuation">,</span>
    readonlyInstrumentations<span class="token punctuation">,</span>
    shallowInstrumentations<span class="token punctuation">,</span>
    shallowReadonlyInstrumentations
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>
  mutableInstrumentations<span class="token punctuation">,</span>
  readonlyInstrumentations<span class="token punctuation">,</span>
  shallowInstrumentations<span class="token punctuation">,</span>
  shallowReadonlyInstrumentations
<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token comment">/* #__PURE__*/</span> <span class="token function">createInstrumentations</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>&emsp;&emsp;可以看到构建时大部分方法都是公用的，只是传入参数不同为了区分<code>readonly</code>、<code>shallow</code>。只读版本的<code>Proxy</code>做增删改时都是弹出警告。所以真实的实现只有<code>get</code>、<code>has</code>、<code>size</code>、<code>set</code>、<code>add</code>、<code>delete</code>、<code>clear</code>、<code>createForEach</code>、<code>createIterableMethod</code>等函数。</p>
<p>&emsp;&emsp;<code>keys</code>, <code>values</code>, <code>entries</code>, <code>Symbol.iterator</code>，都使用<code>createIterableMethod</code>来构建的，为了区分还会将当前的<code>method</code>传入。</p>
<p>&emsp;&emsp;其中集合的<code>size</code>是属性，为了能够附加操作还将它改造成<code>getter</code>函数。</p>
<h3 id="get-修改器、size-修改器和-has-修改器">get 修改器、size 修改器和 has 修改器</h3>
<pre><code class="language-js"><span class="token comment">// 辅助方法，转化为shallow 什么都不做</span>
<span class="token keyword">const</span> toShallow <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">unknown</span><span class="token operator">></span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token constant">T</span></span> <span class="token operator">=></span> value

<span class="token comment">// get拦截器</span>
<span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token parameter">target<span class="token operator">:</span> MapTypes<span class="token punctuation">,</span>
  key<span class="token operator">:</span> unknown<span class="token punctuation">,</span>
  isReadonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  isShallow <span class="token operator">=</span> <span class="token boolean">false</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果出现readonly(reactive(Map)) 的情况，在readonly代理中获取到reactive(Map)，</span>
  <span class="token comment">// 确保get时也要经过reactive代理</span>
  target <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span><span class="token punctuation">]</span>
  <span class="token comment">// 获取 target</span>
  <span class="token keyword">const</span> rawTarget <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token comment">// 获取 key target</span>
  <span class="token keyword">const</span> rawKey <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token comment">// 如果key是响应式的</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> rawKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 再track收集一遍响应式key</span>
    <span class="token comment">// 那么用户不管 trigger的是rawKey 还是 key都会触发得到</span>
    <span class="token operator">!</span>isReadonly <span class="token operator">&amp;&amp;</span> <span class="token function">track</span><span class="token punctuation">(</span>rawTarget<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 收集访问了哪个key</span>
  <span class="token operator">!</span>isReadonly <span class="token operator">&amp;&amp;</span> <span class="token function">track</span><span class="token punctuation">(</span>rawTarget<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> rawKey<span class="token punctuation">)</span>

  <span class="token comment">// 获取集合原型上的has方法</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> has <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getProto</span><span class="token punctuation">(</span>rawTarget<span class="token punctuation">)</span>
  <span class="token comment">// 获取返回值处理函数，根据当前代理类型，将返回值转化为相对应的代理类型</span>
  <span class="token keyword">const</span> wrap <span class="token operator">=</span> isShallow <span class="token operator">?</span> toShallow <span class="token operator">:</span> isReadonly <span class="token operator">?</span> toReadonly <span class="token operator">:</span> toReactive

  <span class="token comment">// 确保 包装后的key 和没包装的key都能访问得到</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>rawTarget<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>rawTarget<span class="token punctuation">,</span> rawKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rawKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!==</span> rawTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果target !== rawTarget,那么就是如果出现readonly(reactive(Map))的情况，</span>
    <span class="token comment">// 确保也要经过reactive代理处理</span>
    target<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// has 拦截器 是否shallow处理方式都一样</span>
<span class="token keyword">function</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> CollectionTypes<span class="token punctuation">,</span> key<span class="token operator">:</span> unknown<span class="token punctuation">,</span> isReadonly <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token comment">// 获取代理前数据</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> rawTarget <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">const</span> rawKey <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token comment">// 如果key是响应式的都收集一遍</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> rawKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">!</span>isReadonly <span class="token operator">&amp;&amp;</span> <span class="token function">track</span><span class="token punctuation">(</span>rawTarget<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">HAS</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token operator">!</span>isReadonly <span class="token operator">&amp;&amp;</span> <span class="token function">track</span><span class="token punctuation">(</span>rawTarget<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">HAS</span><span class="token punctuation">,</span> rawKey<span class="token punctuation">)</span>

  <span class="token comment">// 如果key是proxy, 那么先获取has(keyProxy),再获取has(key)确保获取结果正确</span>
  <span class="token keyword">return</span> key <span class="token operator">===</span> rawKey
    <span class="token operator">?</span> target<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token operator">:</span> target<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> target<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>rawKey<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// size 拦截器 是否shallow处理方式都一样</span>
<span class="token keyword">function</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> IterableCollections<span class="token punctuation">,</span> isReadonly <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取封装对象</span>
  target <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span><span class="token punctuation">]</span>
  <span class="token comment">// 收集获取迭代</span>
  <span class="token operator">!</span>isReadonly <span class="token operator">&amp;&amp;</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token function">toRaw</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">ITERATE</span><span class="token punctuation">,</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'size'</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
<p>&emsp;&emsp;和常用拦截器附加逻辑差不多，和将获取的值转化为当前<code>proxy</code>类型的<code>proxy</code>，<code>track</code>依赖，不过有细微的区别。</p>
<p>&emsp;&emsp;看到<code>(target as any)[ReactiveFlags.RAW]</code>会获取当前代理前的数据，这是为了防止<code>readonly(reactive(Map))</code>类型的代理获取的值返回的是<code>readonly</code>类型的代理，所以获取<code>readonly</code>前的数据也就是<code>reactive(Map)</code>进行<code>get</code>这样获取也会经过<code>reactive</code>代理修改器，获取回来的就是<code>toReadonly(toReactive(Raw))</code>。为什么常用处理器不用呢，因为它是通过代理拦截器的第一个参数直接获取的，就是代理前的数据。</p>
<p>&emsp;&emsp;还有当<code>Map</code>和<code>WeakMap</code>获取数据是，会检测<code>key</code>是否是<code>Proxy</code>，如果是的话，会<code>track</code>两次，这是因为<code>Map</code>和<code>WeakMap</code>的<code>key</code>可以是对象，用户可能将<code>Proxy</code>当做<code>key</code>，当然在<code>set</code>的时候会将<code>key</code>转化为原始数据存储，但是在初始化的时候不会做检测，所以为了确保能正确的触发，两次收集时必要的，否则当存储是<code>proxy</code>的<code>key</code>的话将无法触发。例如：</p>
<pre><code class="language-js"><span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rMap <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 如果没有收集到 keyProxy的话将无法触发</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="set-修改器、delete-修改器和-clear-修改器">set 修改器、delete 修改器和 clear 修改器</h3>
<pre><code class="language-js"><span class="token comment">// 检查key是否是响应式的</span>
<span class="token keyword">function</span> <span class="token function">checkIdentityKeys</span><span class="token punctuation">(</span>
  target<span class="token operator">:</span> CollectionTypes<span class="token punctuation">,</span>
  <span class="token function-variable function">has</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token operator">:</span> unknown</span><span class="token punctuation">)</span> <span class="token operator">=></span> boolean<span class="token punctuation">,</span>
  key<span class="token operator">:</span> unknown
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> rawKey <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rawKey <span class="token operator">!==</span> key <span class="token operator">&amp;&amp;</span> <span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> rawKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token function">toRawType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Reactive </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> contains both the raw and reactive </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">versions of the same object</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Map</span><span class="token template-punctuation string">`</span></span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> as keys</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">which can lead to inconsistencies. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Avoid differentiating between the raw and reactive versions </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">of an object and only use the reactive version if possible.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Map set处理器</span>
<span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> MapTypes<span class="token punctuation">,</span> key<span class="token operator">:</span> unknown<span class="token punctuation">,</span> value<span class="token operator">:</span> unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 存origin value</span>
  value <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取origin target</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> has<span class="token punctuation">,</span> get <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getProto</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 查看当前key是否存在</span>
  <span class="token keyword">let</span> hadKey <span class="token operator">=</span> <span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果不存在则获取 origin</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    key <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hadKey <span class="token operator">=</span> <span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查当前是否包含原始版本 和响应版本在target中</span>
    <span class="token function">checkIdentityKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> has<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取旧的value</span>
  <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置新值</span>
  target<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">ADD</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Set add拦截器</span>
<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> SetTypes<span class="token punctuation">,</span> value<span class="token operator">:</span> unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 存origin value</span>
  value <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取origin target</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> proto <span class="token operator">=</span> <span class="token function">getProto</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 查看是否存在要添加的value</span>
  <span class="token keyword">const</span> hadKey <span class="token operator">=</span> proto<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 不存在添加，并且trigger</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">ADD</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// clear拦截器</span>
<span class="token keyword">function</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> IterableCollections</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取是否存在数据</span>
  <span class="token keyword">const</span> hadItems <span class="token operator">=</span> target<span class="token punctuation">.</span>size <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 构建一个map set作为旧数据</span>
  <span class="token keyword">const</span> oldTarget <span class="token operator">=</span> __DEV__
    <span class="token operator">?</span> <span class="token function">isMap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> result <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hadItems<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">CLEAR</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> oldTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&emsp;&emsp;这些修改器也和我们猜想的差不多，主要职责是<code>trigger</code>。并且会确保<code>set</code>和<code>add</code>进去的值是<code>Target</code>而不是<code>Proxy</code>。其中<code>Map</code>和<code>WeakMap</code>的<code>set</code>修改器还会检测当前<code>key</code>是否存储了两份版本即是<code>proxy</code>和原始版本的<code>key</code>，如果有的话则弹出警告。<code>Set</code>和<code>WeakSet</code>的<code>add</code>修改器会检测当前是否存在，如果存在则不在触发因为<code>Set</code>内不是会有重复数据的。</p>
<h3 id="createforeach-修改器和-createiterablemethod-修改器">createForEach 修改器和 createIterableMethod 修改器</h3>
<pre><code class="language-js"><span class="token comment">// forEach拦截器</span>
<span class="token keyword">function</span> <span class="token function">createForEach</span><span class="token punctuation">(</span><span class="token parameter">isReadonly<span class="token operator">:</span> boolean<span class="token punctuation">,</span> isShallow<span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">forEach</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> IterableCollections<span class="token punctuation">,</span>
    callback<span class="token operator">:</span> Function<span class="token punctuation">,</span>
    thisArg<span class="token operator">?</span><span class="token operator">:</span> unknown</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token keyword">this</span> <span class="token keyword">as</span> any
    <span class="token keyword">const</span> target <span class="token operator">=</span> observed<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> rawTarget <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token comment">// 转化器</span>
    <span class="token keyword">const</span> wrap <span class="token operator">=</span> isShallow <span class="token operator">?</span> toShallow <span class="token operator">:</span> isReadonly <span class="token operator">?</span> toReadonly <span class="token operator">:</span> toReactive
    <span class="token comment">// track当前</span>
    <span class="token operator">!</span>isReadonly <span class="token operator">&amp;&amp;</span> <span class="token function">track</span><span class="token punctuation">(</span>rawTarget<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">ITERATE</span><span class="token punctuation">,</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>
    <span class="token comment">// origin foreach</span>
    <span class="token keyword">return</span> target<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> unknown<span class="token punctuation">,</span> key<span class="token operator">:</span> unknown</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// 确保用户拿到的值是响应式的</span>
      <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>thisArg<span class="token punctuation">,</span> <span class="token function">wrap</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">wrap</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> observed<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建迭代器拦截器  keys values Symbol.interator使用</span>
<span class="token keyword">function</span> <span class="token function">createIterableMethod</span><span class="token punctuation">(</span>
  <span class="token parameter">method<span class="token operator">:</span> string <span class="token operator">|</span> symbol<span class="token punctuation">,</span>
  isReadonly<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  isShallow<span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 返回迭代器</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
    <span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> IterableCollections<span class="token punctuation">,</span>
    <span class="token operator">...</span>args<span class="token operator">:</span> unknown<span class="token punctuation">[</span><span class="token punctuation">]</span></span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Iterable <span class="token operator">&amp;</span> Iterator <span class="token punctuation">{</span>
    <span class="token comment">// 获取封装对象</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span><span class="token punctuation">]</span>
    <span class="token comment">// 源对象 </span>
    <span class="token keyword">const</span> rawTarget <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token comment">// 是否是map</span>
    <span class="token keyword">const</span> targetIsMap <span class="token operator">=</span> <span class="token function">isMap</span><span class="token punctuation">(</span>rawTarget<span class="token punctuation">)</span>
    <span class="token comment">// 是否需要返回一对[key, val]</span>
    <span class="token keyword">const</span> isPair <span class="token operator">=</span>
      method <span class="token operator">===</span> <span class="token string">'entries'</span> <span class="token operator">||</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> Symbol<span class="token punctuation">.</span>iterator <span class="token operator">&amp;&amp;</span> targetIsMap<span class="token punctuation">)</span>
    <span class="token comment">// 是否只需要返回key</span>
    <span class="token keyword">const</span> isKeyOnly <span class="token operator">=</span> method <span class="token operator">===</span> <span class="token string">'keys'</span> <span class="token operator">&amp;&amp;</span> targetIsMap
    <span class="token comment">// 获取封装对象迭代器</span>
    <span class="token keyword">const</span> innerIterator <span class="token operator">=</span> target<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token comment">// 转化函数</span>
    <span class="token keyword">const</span> wrap <span class="token operator">=</span> isShallow <span class="token operator">?</span> toShallow <span class="token operator">:</span> isReadonly <span class="token operator">?</span> toReadonly <span class="token operator">:</span> toReactive
    <span class="token comment">// track当前对象</span>
    <span class="token operator">!</span>isReadonly <span class="token operator">&amp;&amp;</span>
      <span class="token function">track</span><span class="token punctuation">(</span>
        rawTarget<span class="token punctuation">,</span>
        TrackOpTypes<span class="token punctuation">.</span><span class="token constant">ITERATE</span><span class="token punctuation">,</span>
        isKeyOnly <span class="token operator">?</span> <span class="token constant">MAP_KEY_ITERATE_KEY</span> <span class="token operator">:</span> <span class="token constant">ITERATE_KEY</span>
      <span class="token punctuation">)</span>
      
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// 迭代器直接使用</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 直接使用封装对象迭代器，再转化为响应式版本</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> innerIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> done
          <span class="token operator">?</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span>
          <span class="token operator">:</span> <span class="token punctuation">{</span>
              value<span class="token operator">:</span> isPair <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token function">wrap</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">wrap</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token function">wrap</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
              done
            <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 给 keys values entries 方法调用时创建迭代器</span>
      <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&emsp;&emsp;我们先看看<code>forEach</code>修改器的实现，这里会将获取的每个<code>key</code>，<code>value</code>都转化为相对应的代理，确保用户通过<code>Proxy</code>获取的都是<code>Proxy</code>，也相对比较简单。</p>
<p>&emsp;&emsp;在看迭代器修改器前我们先回忆一下迭代器对象的实现方式，首先迭代器对象上必须返回带有<code>Symbol.iterator</code>方法，这个方法必须有<code>next</code>方法，<code>next</code>方法需要放回带有<code>value</code>和<code>done</code>属性的对象，当<code>done</code>为<code>true</code>时表示完成迭代到达边界，下面我们实现一个简单的迭代器对象：</p>
<pre><code class="language-js"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> test <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            value<span class="token operator">:</span> i<span class="token operator">++</span><span class="token punctuation">,</span>
            done<span class="token operator">:</span> <span class="token boolean">false</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            done<span class="token operator">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// [0,1,2,3,4]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>test<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<p>&emsp;&emsp;接下来我们再看迭代器修改器的实现，<code>keys</code>, <code>values</code>, <code>entries</code>, 等方法都有一个共同的特征就是返回的是迭代器对象，所以当执行的时候要确保能够返回<code>{[Symbol.iterator](): {next: ...}}</code>，当访问<code>Symbol.iterator</code>时就直接返回<code>{next: ...}</code>，可以看到这段代码写的很精妙，为了确保两者都能兼容直接在<code>Symbol.iterator</code>的实现中返回<code>this</code>。为了方便理解我将不必要代码剔除掉，如下：</p>
<pre><code class="language-js"><span class="token keyword">const</span> keyInterator <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">/**
 * keyInterator相当于
 *  {
 *    [Symbol.iterator]() {
 *      return {
 *        next () {
 *          ...
 *        }
 *      }
 *    }
 *  }
 **/</span>
</code></pre>
<p>&emsp;&emsp;<code>vue</code>通过特定的<code>method</code>和是否是<code>Map</code>来判断当前需要返回的是键值对还是单值，同时确认好<code>key</code>是使用<code>MAP_KEY_ITERATE_KEY</code>还是<code>ITERATE_KEY</code>，会用使用集合自身的迭代器实现获取结果，然后转化为与当前<code>Proxy</code>类型一致的值返回给用户。</p>
<p>&emsp;&emsp;到这里我们<code>reactive</code>中具体的实现就已经看完了，这里我们总结一下重要的知识点。</p>
<h2 id="小结">小结</h2>
<ul>
<li><b>创建代理对象的<code>Target</code>必须为对象，不能为基础对象</b></li>
<li><b><code>reactive</code>类型可以转化为<code>readonly</code>但是不能逆转</b></li>
<li><b>同一个对象不会创建两次，会在<code>map</code>中查看当前对象是否已经创建，如果创建了直接返回缓存中的</b></li>
<li><b><code>Proxy</code>对象不能创建原型被冻结的和被<code>mark</code>的对象</b></li>
<li><b><code>track</code>和<code>trigger</code>需要传入具体细节</b></li>
<li><b><code>Proxy</code>深入创建时是延迟创建的，在<code>get</code>获取子对象时才会创建子<code>Proxy</code></b></li>
<li><b><code>readonly</code>在<code>get</code>时不会<code>track</code>属性，因为不可变</b></li>
<li><b>系统自带的<code>Symbol</code>和保留属性<code>__proto__</code>、<code>__v_isRef</code>、<code>__isVue</code>不会加入<code>track</code>和创建<code>Proxy</code></b></li>
<li><b><code>Proxy</code>当<code>get</code>到的是<code>ref</code>并且<code>Target</code>不是数组或者是数组但是<code>key</code>不是数组下标时，会自动解包</b></li>
<li><b>当代理<code>Array</code>时，会修改代理上的<code>indexOf</code>、<code>lastIndexOf</code>、<code>includes</code>、<code>push</code>、<code>pop</code>、<code>unshift</code>、<code>splice</code>方法</b></li>
<li><b>使用<code>/*#__PURE__*/</code>告诉打包器是纯变量，没使用时可删减减少包体积</b></li>
<li><b><code>get</code>、<code>has</code>、<code>ownKeys</code>主要职责是<code>track</code></b></li>
<li><b><code>set</code>、<code>delete</code>主要职责是<code>trigger</code></b></li>
<li><b>深入创建<code>proxy</code>是在<code>get</code>拦截器进行的</b></li>
<li><b>因为局限性所以集合类代理是通过修改<code>api</code>来实现的</b></li>
<li><b>在<code>Proxy</code>获取出来的对象始终是与当前<code>Proxy</code>类型相同的<code>Proxy</code></b></li>
<li><b>在<code>Proxy</code>存储数据时始终是存储的原始对象</b></li>
</ul>
</div><div class="style_article-loading-layer__3poja"><div class="style_layer__GxMiF"><div style="fill:var(--vice-color);height:64px;width:64px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
  <circle transform="translate(8 0)" cx="0" cy="16" r="0"> 
    <animate attributeName="r" values="0; 4; 0; 0" dur="1.2s" repeatCount="indefinite" begin="0"
      keytimes="0;0.2;0.7;1" keySplines="0.2 0.2 0.4 0.8;0.2 0.6 0.4 0.8;0.2 0.6 0.4 0.8" calcMode="spline" />
  </circle>
  <circle transform="translate(16 0)" cx="0" cy="16" r="0"> 
    <animate attributeName="r" values="0; 4; 0; 0" dur="1.2s" repeatCount="indefinite" begin="0.3"
      keytimes="0;0.2;0.7;1" keySplines="0.2 0.2 0.4 0.8;0.2 0.6 0.4 0.8;0.2 0.6 0.4 0.8" calcMode="spline" />
  </circle>
  <circle transform="translate(24 0)" cx="0" cy="16" r="0"> 
    <animate attributeName="r" values="0; 4; 0; 0" dur="1.2s" repeatCount="indefinite" begin="0.6"
      keytimes="0;0.2;0.7;1" keySplines="0.2 0.2 0.4 0.8;0.2 0.6 0.4 0.8;0.2 0.6 0.4 0.8" calcMode="spline" />
  </circle>
</svg>
</div></div></div> </div><div class="style_bottom__29qYA"><p>©2021 - bill-lai 的小站 -<a rel="noreferrer" href="https://github.com/bill-lai/bill-lai.github.io" target="_blank">站点源码</a></p><p>本站使用<a rel="noreferrer" target="_blank" href="https://react.docschina.org/docs/hooks-reference.html#usememo">ReactHook</a><a rel="noreferrer" target="_blank" href="https://www.typescriptlang.org/zh/">TypeScript</a><a rel="noreferrer" target="_blank" href="https://docs.github.com/cn/rest">githubAPI</a><a rel="noreferrer" target="_blank" href="https://simplemde.com/">SimpleMDE</a>制作</p></div></div><div class="style_right-layer__Rm9TS "><div class="style_right__3hdcL"><div class="style_right-content__F68mu"><div class="navigation"><h4 class="style_title__1aA1F">目录列表</h4><ul class="style_top-navs__3vyAr"><li class=""><span>阅读准备<!-- --> </span></li><li class=""><span>思考实现<!-- --> </span></li><li class=""><span>入口<!-- --> </span></li><li class=""><span>常用拦截器<!-- --> <i class="iconfont icon-arrow_down"></i></span><ul class="style_child-navs__6paad"><li class=""><span>get 拦截器<!-- --> </span><ul class="style_child-navs__6paad"><li class=""><span>Array 改造器<!-- --> </span></li></ul></li><li class=""><span>set 拦截器和 delete 拦截器<!-- --> </span></li><li class=""><span>has 拦截器和 ownKeys 拦截器<!-- --> </span></li></ul></li><li class=""><span>集合拦截器<!-- --> <i class="iconfont icon-arrow_down"></i></span><ul class="style_child-navs__6paad"><li class=""><span>get 修改器、size 修改器和 has 修改器<!-- --> </span></li><li class=""><span>set 修改器、delete 修改器和 clear 修改器<!-- --> </span></li><li class=""><span>createForEach 修改器和 createIterableMethod 修改器<!-- --> </span></li></ul></li><li class=""><span>小结<!-- --> </span></li></ul></div></div></div></div></div></div></div></div>
          <script>var globalState = {"article/6452d43210bfdd32fd3c":{"title":"vue3-reactive源码解析","id":"6452d43210bfdd32fd3c","mtime":1644416825417,"ctime":1644415322115,"issues":{"number":12,"commentsUrl":"https://api.github.com/repos/bill-lai/bill-lai.github.io/issues/12/comments","reactionsUrl":"https://api.github.com/repos/bill-lai/bill-lai.github.io/issues/12/reactions"},"head":null,"foot":null,"dirs":[{"leave":2,"title":"阅读准备","children":[]},{"leave":2,"title":"思考实现","children":[]},{"leave":2,"title":"入口","children":[]},{"leave":2,"title":"常用拦截器","children":[{"leave":3,"title":"get 拦截器","children":[{"leave":4,"title":"Array 改造器","children":[]}]},{"leave":3,"title":"set 拦截器和 delete 拦截器","children":[]},{"leave":3,"title":"has 拦截器和 ownKeys 拦截器","children":[]}]},{"leave":2,"title":"集合拦截器","children":[{"leave":3,"title":"get 修改器、size 修改器和 has 修改器","children":[]},{"leave":3,"title":"set 修改器、delete 修改器和 clear 修改器","children":[]},{"leave":3,"title":"createForEach 修改器和 createIterableMethod 修改器","children":[]}]},{"leave":2,"title":"小结","children":[]}],"body":"<h2 id=\"阅读准备\">阅读准备</h2>\n<p>在阅读 reactive 源码之前，我们需要知道它的特性，了解特性推荐阅读单例测试源码或者是阅读官网的 API，推荐阅读单例，在后面阅读时才能更好理解。vue中响应式数据是通过<code>Proxy</code>来实现的，可以通过我之前写的<a href=\"https://bill-lai.github.io/article/d6de1bf5f0382cf53f5e/\">Proxy 和 Reflect</a>来了解它的特性和一些注意事项。</p>\n<p>在<code>vue3</code>中使用创建<code>reactive</code>类对象一共有四种<code>api</code>，分别对应不同的功能的对象</p>\n<ul>\n<li><code>reactive</code>创建可深入响应的可读写对象</li>\n<li><code>readonly</code>创建可深入响应的只读对象</li>\n<li><code>shallowReactive</code>创建只有表层（一层）的浅可读写对象</li>\n<li><code>shallowReadonly</code>创建只有表层（一层）的浅只读对象</li>\n</ul>\n<p>使用<code>reactive</code>和<code>readonly</code>时会自动解构对象且不包括是数组子项的<code>Ref</code>对象，无论解构有多深，而 <code>shallow</code>类的对象则不会自动解构，只有一层也不会自动解构。比如</p>\n<pre><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> reactive<span class=\"token punctuation\">,</span> ref <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'vue'</span>\n\n<span class=\"token keyword\">const</span> observed1 <span class=\"token operator\">=</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  a<span class=\"token operator\">:</span> <span class=\"token function\">ref</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  b<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    c<span class=\"token operator\">:</span> <span class=\"token function\">ref</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  e<span class=\"token operator\">:</span> <span class=\"token function\">ref</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> c<span class=\"token operator\">:</span> <span class=\"token function\">ref</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  d<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">ref</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> a<span class=\"token operator\">:</span> <span class=\"token function\">ref</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">const</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> observed2 <span class=\"token operator\">=</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  d<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">ref</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">const</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nobserved2<span class=\"token punctuation\">.</span>_a <span class=\"token operator\">=</span> <span class=\"token function\">ref</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>v<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// Number 1</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>observed1<span class=\"token punctuation\">.</span>a<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// Number 1</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>observed1<span class=\"token punctuation\">.</span>b<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// Number 1</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>observed1<span class=\"token punctuation\">.</span>e<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// RefImpl value: Number 1</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>observed1<span class=\"token punctuation\">.</span>d<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// Number 1</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>observed1<span class=\"token punctuation\">.</span>d<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>a<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// RefImpl value: Number 1</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>observed2<span class=\"token punctuation\">.</span>d<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// Number 1</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>observed2<span class=\"token punctuation\">.</span>_a<span class=\"token punctuation\">.</span>v<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">const</span> shallowObserved <span class=\"token operator\">=</span> <span class=\"token function\">shallowReactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  a<span class=\"token operator\">:</span> <span class=\"token function\">ref</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// RefImpl value: Number 1</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>observed<span class=\"token punctuation\">.</span>a<span class=\"token punctuation\">)</span>\n</code></pre>\n<p><code>reactive</code>深入对象内部创建子代理时遇到下面这些情况不会创建</p>\n<ul>\n<li>不可更改属性描述符的对象不会创建，比如调用<code>Object.prevenExtensions</code>使对象不可扩展、<code>Object.freeze</code>冻结对象，<code>Object.seal</code>封闭对象</li>\n<li>在对象上声明<code>__v_skip</code>属性为<code>true</code></li>\n<li>对象调用<code>vue</code>的<code>markRaw</code></li>\n</ul>\n<p><code>reactive</code>对象与<code>readonly</code>对象互相转换时，<code>readonly</code>对象不可转为<code>reactive</code>；<code>reactive</code>可以转为<code>readonly</code>，但是转化的对象使用<code>isReactive</code>和<code>isReadonly</code>函数调用时都是返回<code>true</code>。比如下方代码:</p>\n<pre><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> reactive<span class=\"token punctuation\">,</span> readonly<span class=\"token punctuation\">,</span> isReactive<span class=\"token punctuation\">,</span> isReadonly <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"vue\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> are <span class=\"token operator\">=</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> a<span class=\"token operator\">:</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> aro <span class=\"token operator\">=</span> <span class=\"token function\">readonly</span><span class=\"token punctuation\">(</span>are<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// true</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">isReactive</span><span class=\"token punctuation\">(</span>aro<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// true</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">isReadonly</span><span class=\"token punctuation\">(</span>aro<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> bre <span class=\"token operator\">=</span> <span class=\"token function\">readonly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> b<span class=\"token operator\">:</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> bro <span class=\"token operator\">=</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span>bre<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// false</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">isReactive</span><span class=\"token punctuation\">(</span>bro<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// true</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">isReadonly</span><span class=\"token punctuation\">(</span>bro<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h2 id=\"思考实现\">思考实现</h2>\n<p>&emsp;&emsp;如果让我们基于<code>Proxy</code>来实现<code>vue</code>的响应式数据的话，我们会怎么设计呢，如果是我会这样设计，因为是响应式的，那么我们必须知道是哪些属性被使用，在它更改时需要重新执行监听函数，我们可以把监听函数跟收集函数统一使用一个函数来执行，而收集的函数里面收集到的<code>key</code>可能是动态的，所以每次更改都要清空依赖重新收集一遍依赖，加上<code>Proxy</code>的特性所以当收集函数使用<code>get</code>获取数据时收集当前使用<code>key</code>，当外部<code>set</code>修改数据时查看当前<code>set</code>是查看<code>key</code>是否被收集，如果被收集了，则<code>set</code>之后重新触发收集函数再次收集，而<code>vue3</code>中这个收集函数就是<code>effect</code>。当然真实使用时肯定不止<code>get</code>，<code>set</code>这里为了方便理解，我们先按简单的看。逻辑如下图所示</p>\n<p><img src=\"/article/6452d43210bfdd32fd3c/./image/realize.drawio.svg\" alt=\"unwrap-ref.png\"></p>\n<p>&emsp;&emsp;为了充分覆盖用户的数据，在<code>Proxy</code>获取的数据应该始终是<code>Proxy</code>，否则当用户修改里面的子对象时无法监听，比如下方这种情况</p>\n<pre><code class=\"language-js\"><span class=\"token keyword\">const</span> rt <span class=\"token operator\">=</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>a<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>b<span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 代理内部也应该将 rt.a 转化为代理</span>\n<span class=\"token keyword\">const</span> ra <span class=\"token operator\">=</span> ra<span class=\"token punctuation\">.</span>a\n<span class=\"token function\">effect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 收集到依赖</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ra<span class=\"token punctuation\">.</span>b<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 触发重新执行effect</span>\nra<span class=\"token punctuation\">.</span>b <span class=\"token operator\">=</span> <span class=\"token number\">4</span>\n</code></pre>\n<p>&emsp;&emsp;还有一个原则，就是存储到原始数据时始终不应该存储<code>Proxy</code>后的数据，否则会造成混乱。</p>\n<h2 id=\"入口\">入口</h2>\n<p>&emsp;&emsp;在<code>vue3</code>中创建（除去<code>ref</code>）中创建响应式对象一共有四种方法，分别是<code>reactive</code>、<code>shallowReactive</code>、<code>readonly</code>、<code>shallowReadonly</code>这四种方法的入口源码如下</p>\n<pre><code class=\"language-js\">\n<span class=\"token comment\">// 创建reactive对象</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token operator\">:</span> object</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 如果reactive进入的是readonly的话直接返回，保持只读</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>target <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>target <span class=\"token keyword\">as</span> Target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">IS_READONLY</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> target\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 创建reactive对象</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">createReactiveObject</span><span class=\"token punctuation\">(</span>\n    target<span class=\"token punctuation\">,</span>\n    <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    mutableHandlers<span class=\"token punctuation\">,</span>\n    mutableCollectionHandlers<span class=\"token punctuation\">,</span>\n    reactiveMap\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// shallowReactive创建，不会自动解包，只有根级别属性才是反应式的</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> shallowReactive<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">object</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  target<span class=\"token operator\">:</span> <span class=\"token constant\">T</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ShallowReactive<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">createReactiveObject</span><span class=\"token punctuation\">(</span>\n    target<span class=\"token punctuation\">,</span>\n    <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    shallowReactiveHandlers<span class=\"token punctuation\">,</span>\n    shallowCollectionHandlers<span class=\"token punctuation\">,</span>\n    shallowReactiveMap\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 创建readonly代理，如果已经是reactive可以附加readonly标识</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> readonly<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">object</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  target<span class=\"token operator\">:</span> <span class=\"token constant\">T</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> DeepReadonly<span class=\"token operator\">&lt;</span>UnwrapNestedRefs<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">>></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">createReactiveObject</span><span class=\"token punctuation\">(</span>\n    target<span class=\"token punctuation\">,</span>\n    <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    readonlyHandlers<span class=\"token punctuation\">,</span>\n    readonlyCollectionHandlers<span class=\"token punctuation\">,</span>\n    readonlyMap\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> shallowReadonly<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">object</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Readonly<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">createReactiveObject</span><span class=\"token punctuation\">(</span>\n    target<span class=\"token punctuation\">,</span>\n    <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    shallowReadonlyHandlers<span class=\"token punctuation\">,</span>\n    shallowReadonlyCollectionHandlers<span class=\"token punctuation\">,</span>\n    shallowReadonlyMap\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>&emsp;&emsp;在上面源码我们可以看到，这四种创建响应式对象最终都是使用<code>createReactiveObject</code>方法来实现的，只是参数不一样， 第一个参数是加工对象，第二个参数是标识只读和可读写，为<code>true</code>时为只读，第三四个参数是代理的拦截器，一个是常用类型拦截器，一个是集合类型拦截器，这里集合数据标识<code>Map</code>、<code>Set</code>、<code>WeakMap</code>、<code>WeakSet</code>为什么将他们区分实现，可以查看之前我写的<a href=\"https://bill-lai.github.io/article/d6de1bf5f0382cf53f5e/#%E4%BB%A3%E7%90%86%E5%85%B7%E6%9C%89%E7%A7%81%E6%9C%89%E5%B1%9E%E6%80%A7%E7%9A%84%E5%AF%B9%E8%B1%A1\">代理具有内部插槽的内建对象</a>，而且集合类型是通过<code>api</code>来获取和存储数据的，并且存储时不会经过代理，代理只能拦截到获取<code>api</code>和特定的属性（如<code>size</code>）。最后一个参数就是每个代理类型<em>（是否<code>shallow（浅处理）</code>和是否只读）</em>的存储池了，里面存储了每个对象与代理的<code>map</code>关系。</p>\n<p>&emsp;&emsp;我们看看四种代理类型的 Map 声明：</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// origin与proxy的映射</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> reactiveMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakMap</span><span class=\"token operator\">&lt;</span>Target<span class=\"token punctuation\">,</span> any<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> shallowReactiveMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakMap</span><span class=\"token operator\">&lt;</span>Target<span class=\"token punctuation\">,</span> any<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> readonlyMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakMap</span><span class=\"token operator\">&lt;</span>Target<span class=\"token punctuation\">,</span> any<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> shallowReadonlyMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakMap</span><span class=\"token operator\">&lt;</span>Target<span class=\"token punctuation\">,</span> any<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<p>&emsp;&emsp;存储<code>map</code>都是用<code>WeakMap</code>当用户丢弃这个代理和代理对象时会自动进行内存回收，方便管理。<br>接下来我们看看真正的入口源码：</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// 创建代理对象</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createReactiveObject</span><span class=\"token punctuation\">(</span>\n  <span class=\"token comment\">// 要代理的数据</span>\n  target<span class=\"token operator\">:</span> Target<span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 是否是只读</span>\n  isReadonly<span class=\"token operator\">:</span> boolean<span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 基础代理器</span>\n  baseHandlers<span class=\"token operator\">:</span> ProxyHandler<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 集合代理器</span>\n  collectionHandlers<span class=\"token operator\">:</span> ProxyHandler<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 映射map</span>\n  proxyMap<span class=\"token operator\">:</span> WeakMap<span class=\"token operator\">&lt;</span>Target<span class=\"token punctuation\">,</span> any<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 如果代理的数据不是obj则直接返回原对象</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isObject</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>__DEV__<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">value cannot be made reactive: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 如果传入的已经是代理了，而且不是readonly -> reactive的转换则直接返回</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    target<span class=\"token punctuation\">[</span>ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">RAW</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span>\n    <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>isReadonly <span class=\"token operator\">&amp;&amp;</span> target<span class=\"token punctuation\">[</span>ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">IS_REACTIVE</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 查看当前origin对象之前是不是创建过当前代理，如果创建过直接返回之前缓存的代理对象</span>\n  <span class=\"token keyword\">const</span> existingProxy <span class=\"token operator\">=</span> proxyMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existingProxy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> existingProxy<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 如果当前对象无法创建代理则直接返回origin</span>\n  <span class=\"token keyword\">const</span> targetType <span class=\"token operator\">=</span> <span class=\"token function\">getTargetType</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>targetType <span class=\"token operator\">===</span> TargetType<span class=\"token punctuation\">.</span><span class=\"token constant\">INVALID</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 查看当前origin type选择集合拦截器还是基础拦截器</span>\n  <span class=\"token keyword\">const</span> proxy <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">(</span>\n    target<span class=\"token punctuation\">,</span>\n    targetType <span class=\"token operator\">===</span> TargetType<span class=\"token punctuation\">.</span><span class=\"token constant\">COLLECTION</span> <span class=\"token operator\">?</span> collectionHandlers <span class=\"token operator\">:</span> baseHandlers\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 缓存</span>\n  proxyMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> proxy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> proxy<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>&emsp;&emsp;在<code>createReactiveObject</code>实现用到了<code>ReactiveFlags</code>，这些都是当前代理的特定标识，在后面代理具体实现中会附加上，稍后讲到具体实现时能看到，这些标识分别是：</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// reactive 标志符常量</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">enum</span> ReactiveFlags <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 是否阻止成为代理属性</span>\n  <span class=\"token constant\">SKIP</span> <span class=\"token operator\">=</span> <span class=\"token string\">'__v_skip'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 是否是reactive属性</span>\n  <span class=\"token constant\">IS_REACTIVE</span> <span class=\"token operator\">=</span> <span class=\"token string\">'__v_isReactive'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 是否是readonly属性</span>\n  <span class=\"token constant\">IS_READONLY</span> <span class=\"token operator\">=</span> <span class=\"token string\">'__v_isReadonly'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// mark target</span>\n  <span class=\"token constant\">RAW</span> <span class=\"token operator\">=</span> <span class=\"token string\">'__v_raw'</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>&emsp;&emsp;创建代理对象的<code>Target</code>必须为对象，不能为基础对象，<code>reactive</code>类型可以转化为<code>readonly</code>但是不能逆转，同一个对象不会创建两次，会在<code>map</code>中查看当前对象是否已经创建，如果创建了直接返回缓存中的。我们可以看到<code>vue</code>还会给每个对象打上<code>TargetType</code>类型，如果为<code>INVALID</code>的则标识为不可创建，直接返回源对象，<code>TargetType</code>的源码如下：</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// reactive origin类型常量</span>\n<span class=\"token keyword\">const</span> <span class=\"token keyword\">enum</span> TargetType <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 无效的 比如基础数据类型</span>\n  <span class=\"token constant\">INVALID</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 常见的 比如object Array</span>\n  <span class=\"token constant\">COMMON</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 集合类型比如 map set</span>\n  <span class=\"token constant\">COLLECTION</span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 获取origin 类型辅助函数</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">targetTypeMap</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">rawType<span class=\"token operator\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>rawType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'Object'</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'Array'</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> TargetType<span class=\"token punctuation\">.</span><span class=\"token constant\">COMMON</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'Map'</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'Set'</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'WeakMap'</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'WeakSet'</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> TargetType<span class=\"token punctuation\">.</span><span class=\"token constant\">COLLECTION</span>\n    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> TargetType<span class=\"token punctuation\">.</span><span class=\"token constant\">INVALID</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> toRawType <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>value<span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token parameter\">string</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// extract \"RawType\" from strings like \"[object RawType]\"</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">toTypeString</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 获取origin的类型</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">getTargetType</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value<span class=\"token operator\">:</span> Target</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 如果mark了不可reactive或者是不可扩展的直接返回无效</span>\n  <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">[</span>ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">SKIP</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>Object<span class=\"token punctuation\">.</span><span class=\"token function\">isExtensible</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">?</span> TargetType<span class=\"token punctuation\">.</span><span class=\"token constant\">INVALID</span>\n    <span class=\"token operator\">:</span> <span class=\"token function\">targetTypeMap</span><span class=\"token punctuation\">(</span><span class=\"token function\">toRawType</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>&emsp;&emsp;可以看到<code>Vue</code>中的<code>Proxy</code>对象不能创建原型被冻结的对象，这个很好理解，因为<code>Vue</code>需要对<code>Target</code>代理附加很多东西，原型被冻结将会附加失败。被用户主动<code>mark</code>的对象也不能创建。<code>markRaw</code>的源码如下:</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// 记录对象不可代理</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> markRaw<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">object</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>value<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token constant\">T</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">def</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">SKIP</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> value\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>&emsp;&emsp;<code>createReactiveObject</code>会根据<code>getTargetType</code>返回的数据类型来选择是使用<code>collectionHandlers</code>集合拦截器还是<code>baseHandlers</code>常用拦截器。创建完成后会将代理缓存起来，方便下次获取和查询。到这里入口就已经看完了。接下来我们看看一些辅助函数，这些函数比较简单这里就不再讲解了：</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// 是否是reactive</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">isReactive</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value<span class=\"token operator\">:</span> unknown</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> boolean <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 如果当前value是readonly则查看raw是不是reactive</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isReadonly</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">isReactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>value <span class=\"token keyword\">as</span> Target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">RAW</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>value <span class=\"token keyword\">as</span> Target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">IS_REACTIVE</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 是否是readonly</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">isReadonly</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value<span class=\"token operator\">:</span> unknown</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> boolean <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>value <span class=\"token keyword\">as</span> Target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">IS_READONLY</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 查看当前是否是proxy，为reactive 或readonly则为内部代理</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">isProxy</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value<span class=\"token operator\">:</span> unknown</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> boolean <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">isReactive</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token function\">isReadonly</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 获取数据原始值</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> toRaw<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>observed<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token constant\">T</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 获取reactive原始对象，因为可能会有 readonly(reactive({}))写法，所以需要深入获取</span>\n  <span class=\"token keyword\">const</span> raw <span class=\"token operator\">=</span> observed <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>observed <span class=\"token keyword\">as</span> Target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">RAW</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">return</span> raw <span class=\"token operator\">?</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>raw<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> observed\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 将对象转化为reactive</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> toReactive <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">unknown</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>value<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token parameter\"><span class=\"token constant\">T</span></span> <span class=\"token operator\">=></span>\n  <span class=\"token function\">isObject</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> value\n\n<span class=\"token comment\">// 对象转化为readonly</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> toReadonly <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">unknown</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>value<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token parameter\"><span class=\"token constant\">T</span></span> <span class=\"token operator\">=></span>\n  <span class=\"token function\">isObject</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">readonly</span><span class=\"token punctuation\">(</span>value <span class=\"token keyword\">as</span> Record<span class=\"token operator\">&lt;</span>any<span class=\"token punctuation\">,</span> any<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> value\n</code></pre>\n<!-- \n&emsp;&emsp;到这里我们还没看到`Vue`为`Proxy`标记`ReactiveFlags`，不着急`ReactiveFlags`是在拦截器中声明，我们下面会讲到。 -->\n\n<p>&emsp;&emsp;在思考实现中我们讲到<code>Proxy</code>会收集和重新调用<code>effect</code>,在<code>vue</code>中做了进一步的细分，会用枚举区分因为什么操作收集，因为什么操作重新执行，定义的常量如下</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// 因为什么收集</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">enum</span> TrackOpTypes <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 如 observed.a</span>\n  <span class=\"token constant\">GET</span> <span class=\"token operator\">=</span> <span class=\"token string\">'get'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 如 a in observed</span>\n  <span class=\"token constant\">HAS</span> <span class=\"token operator\">=</span> <span class=\"token string\">'has'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 如 Object.keys(observed)</span>\n  <span class=\"token constant\">ITERATE</span> <span class=\"token operator\">=</span> <span class=\"token string\">'iterate'</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 因为什么重新触发</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">enum</span> TriggerOpTypes <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 如修改 observed.a = 1</span>\n  <span class=\"token constant\">SET</span> <span class=\"token operator\">=</span> <span class=\"token string\">'set'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 如新增 observed.b = 3</span>\n  <span class=\"token constant\">ADD</span> <span class=\"token operator\">=</span> <span class=\"token string\">'add'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 如 delete observed.a</span>\n  <span class=\"token constant\">DELETE</span> <span class=\"token operator\">=</span> <span class=\"token string\">'delete'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 在集合时使用 如map.clear()</span>\n  <span class=\"token constant\">CLEAR</span> <span class=\"token operator\">=</span> <span class=\"token string\">'clear'</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>&emsp;&emsp;在<code>vue</code>中收集依赖统一使用<code>track</code>函数，重新触发<code>effect</code>是统一使用<code>trigger</code>函数，<code>track</code>和<code>trigger</code>除了收集操作枚举外还需要传入<code>key</code>，操作什么<code>key</code>引起的收集和触发，如果是因为<code>ownKey</code>（如<code>Object.key(...)</code>）引起的收集会使用一个内置的常量<code>ITERATE_KEY</code>替代<code>key</code>，关于<code>track</code>和<code>trigger</code>里面具体实现我们讲到<code>effect</code>章节时再讲解，这里主要将代理的实现，使用方式如下：</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// 在vue中除了`Map`的`keys`，其他迭代的都用这个symbol来代替key，</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">ITERATE_KEY</span> <span class=\"token operator\">=</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span>__DEV__ <span class=\"token operator\">?</span> <span class=\"token string\">\"iterate\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 收集什么变量，什么操作，收集到什么key</span>\n<span class=\"token function\">track</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TrackOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">ITERATE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">ITERATE_KEY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">track</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TrackOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">GET</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"a\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">track</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TrackOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">HAS</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"a\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 什么变量引起触发，什么操作，变量什么key引起触发，新值、旧值（如果有）</span>\n<span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">ADD</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">SET</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> oldValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">DELETE</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> oldValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h2 id=\"常用拦截器\">常用拦截器</h2>\n<p>&emsp;&emsp;在上面中我们看到常用拦截器对象有四种分别是<code>mutableHandlers</code>、<code>readonlyHandlers</code>、<code>shallowReactiveHandlers</code>、<code>shallowReadonlyHandlers</code>分别对应<code>reactive</code>、<code>readonly</code>、<code>shallowReactive</code>、<code>shallowReadonly</code>类型的代理，接下来我们看看源码实现：</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// 创建get handler</span>\n<span class=\"token keyword\">const</span> get <span class=\"token operator\">=</span> <span class=\"token comment\">/*#__PURE__*/</span> <span class=\"token function\">createGetter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 创shallow的 get handler</span>\n<span class=\"token keyword\">const</span> shallowGet <span class=\"token operator\">=</span> <span class=\"token comment\">/*#__PURE__*/</span> <span class=\"token function\">createGetter</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 创建readonly的 get Handler</span>\n<span class=\"token keyword\">const</span> readonlyGet <span class=\"token operator\">=</span> <span class=\"token comment\">/*#__PURE__*/</span> <span class=\"token function\">createGetter</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 创建shallowReadonly的 get handler</span>\n<span class=\"token keyword\">const</span> shallowReadonlyGet <span class=\"token operator\">=</span> <span class=\"token comment\">/*#__PURE__*/</span> <span class=\"token function\">createGetter</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> set <span class=\"token operator\">=</span> <span class=\"token comment\">/*#__PURE__*/</span> <span class=\"token function\">createSetter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> shallowSet <span class=\"token operator\">=</span> <span class=\"token comment\">/*#__PURE__*/</span> <span class=\"token function\">createSetter</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// reactive拦截器</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> mutableHandlers<span class=\"token operator\">:</span> ProxyHandler<span class=\"token operator\">&lt;</span>object<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  get<span class=\"token punctuation\">,</span>\n  set<span class=\"token punctuation\">,</span>\n  deleteProperty<span class=\"token punctuation\">,</span>\n  has<span class=\"token punctuation\">,</span>\n  ownKeys<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// readonly拦截器</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> readonlyHandlers<span class=\"token operator\">:</span> ProxyHandler<span class=\"token operator\">&lt;</span>object<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  get<span class=\"token operator\">:</span> readonlyGet<span class=\"token punctuation\">,</span>\n  <span class=\"token function\">set</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>__DEV__<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span>\n        <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Set operation on key \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\" failed: target is readonly.</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n        target\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">deleteProperty</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token punctuation\">,</span> key</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>__DEV__<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span>\n        <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Delete operation on key \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\" failed: target is readonly.</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n        target\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// shallow reactive拦截器</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> shallowReactiveHandlers <span class=\"token operator\">=</span> <span class=\"token comment\">/*#__PURE__*/</span> <span class=\"token function\">extend</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  mutableHandlers<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    get<span class=\"token operator\">:</span> shallowGet<span class=\"token punctuation\">,</span>\n    set<span class=\"token operator\">:</span> shallowSet<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> shallowReadonlyHandlers <span class=\"token operator\">=</span> <span class=\"token comment\">/*#__PURE__*/</span> <span class=\"token function\">extend</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  readonlyHandlers<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    get<span class=\"token operator\">:</span> shallowReadonlyGet<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>&emsp;&emsp;拦截器的<code>get</code>、<code>set</code>都是由<code>createGetter</code>、<code>createSetter</code>创建的，只是参数差异，在<code>createGetter</code>函数中第一个参数标识是否只读，第二个参数标识是否<code>shallow</code>，<code>createSetter</code>不带是否只读因为，只读的<code>Proxy</code>不能<code>set</code>，只需要提示不能更改，同理<code>has</code>拦截器也是没必要添加。可能你会想只读的<code>proxy</code>按理来说也不需要<code>get</code>因为对象不会更改，也就不需要收集数据，对了一半，<code>get</code>中确实不会收集，但是<code>vue</code>中代理不仅需要在<code>get</code>拦截器上收集数据而且需要附加<code>Flags</code>和创建子对象<code>proxy</code><em>（如果不是<code>shallow</code>的话）</em>。</p>\n<p>&emsp;&emsp;在上面每个函数前都添加了<code>/*#__PURE__*/</code>这段注释的作用就是提示打包器这些变量时纯的，当没有使用到这些变量时可以剔除，减小打包后包的大小。</p>\n<h3 id=\"get-拦截器\">get 拦截器</h3>\n<p>&emsp;&emsp;我们在思考实现中提到<code>get</code>拦截器大概职责是在<code>effect</code>时收集依赖，除此之外我们还需要保证<code>Proxy get</code>获取到的都是<code>proxy</code>，因为<code>Proxy</code>只是代理当前对象，子对象也需要深入创建，比如<code>const oa = reactive({a: { b: 2 }})</code>需要保证<code>oa.a</code>获取到的也是代理，接下来我们看<code>createGetter</code>源码：</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// 不track收集和创建代理的的keys 包括原型，ref标识 vue标识</span>\n<span class=\"token keyword\">const</span> isNonTrackableKeys <span class=\"token operator\">=</span> <span class=\"token comment\">/*#__PURE__*/</span> <span class=\"token function\">makeMap</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">__proto__,__v_isRef,__isVue</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 获取所有内置的Symbol</span>\n<span class=\"token keyword\">const</span> builtInSymbols <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">getOwnPropertyNames</span><span class=\"token punctuation\">(</span>Symbol<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">key</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>Symbol <span class=\"token keyword\">as</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isSymbol<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 创建get handler</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createGetter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">isReadonly <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> shallow <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token operator\">:</span> Target<span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> string <span class=\"token operator\">|</span> symbol<span class=\"token punctuation\">,</span> receiver<span class=\"token operator\">:</span> object</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 附加flags </span>\n    <span class=\"token comment\">// 获取是否是获取当前是否是reactive | readonly</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">===</span> ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">IS_REACTIVE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span>isReadonly\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">===</span> ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">IS_READONLY</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> isReadonly\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token comment\">// 如果是获取源对象，通过代理和源数据WeakMap获取是否有被创建过</span>\n      key <span class=\"token operator\">===</span> ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">RAW</span> <span class=\"token operator\">&amp;&amp;</span>\n      receiver <span class=\"token operator\">===</span>\n        <span class=\"token punctuation\">(</span>isReadonly\n          <span class=\"token operator\">?</span> shallow\n            <span class=\"token operator\">?</span> shallowReadonlyMap\n            <span class=\"token operator\">:</span> readonlyMap\n          <span class=\"token operator\">:</span> shallow\n          <span class=\"token operator\">?</span> shallowReactiveMap\n          <span class=\"token operator\">:</span> reactiveMap\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 直接返回被代理对象</span>\n      <span class=\"token keyword\">return</span> target\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 是否是数组</span>\n    <span class=\"token keyword\">const</span> targetIsArray <span class=\"token operator\">=</span> <span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// 如果当前数据是数组，而且是访问需要改造器后使用的，则使用改造器访问</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isReadonly <span class=\"token operator\">&amp;&amp;</span> targetIsArray <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">hasOwn</span><span class=\"token punctuation\">(</span>arrayInstrumentations<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>arrayInstrumentations<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> receiver<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> receiver<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// 如果当前key是内置symbol key或者是不需要处理的key则直接返回</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isSymbol</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> builtInSymbols<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">isNonTrackableKeys</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> res\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 如果不是只读的则track收集</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isReadonly<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">track</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TrackOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">GET</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// shallow类直接返回，不需要神UR创建</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shallow<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> res\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isRef</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 是否应该解包ref，如果是不是数组或者是数组但是访问非int key则应该解包</span>\n      <span class=\"token keyword\">const</span> shouldUnwrap <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>targetIsArray <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token function\">isIntegerKey</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> shouldUnwrap <span class=\"token operator\">?</span> res<span class=\"token punctuation\">.</span>value <span class=\"token operator\">:</span> res\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isObject</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 获取时才创建相对应类型的代理，将访问值也转化为reactive</span>\n      <span class=\"token keyword\">return</span> isReadonly <span class=\"token operator\">?</span> <span class=\"token function\">readonly</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> res\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>&emsp;&emsp;<code>createGetter</code>采用闭包包裹当前代理类型，当使用特定<code>Flag</code>属性获取时可以方便的返回当前代理的类型。当获取<code>Proxy</code>代理前数据时必须是已加是加工为代理的对象才能获取。</p>\n<p>&emsp;&emsp;当代理类型是只读时是不会<code>track（收集）</code>依赖的，因为只读代理不会更改，收集没意义。如果是<code>shallow</code>的代理收集后则直接返回结果，因为只浅代理，只创建一层代理，如果不是<code>shallow</code>并且子属性是对象的话就动态创建当前类型的子对象代理。</p>\n<p>&emsp;&emsp;<code>vue</code>的代理深创建子对象<code>proxy</code>时是使用时才创建，比如<code>const ra = readonly({a: {b: 2}})</code>使用这段代码时会创建外层<code>{a: ...}</code>代理，<code>{b: 2}</code>这层并不会马上创建，而是当你使用<code>ra.b</code>时会在<code>get</code>拦截器中创建。</p>\n<p>&emsp;&emsp;<code>vue</code>中有一些保留属性是不会收集和创建子代理的例如<code>__proto__（原型）</code>,<code>__v_isRef（是否是ref）</code>,<code>__isVue（是否是vue）</code>。</p>\n<p>&emsp;&emsp;除此之外还有一些系统自带的<code>Symbol</code>也不会处理，比如<code>Symbol.toStringTag</code>、<code>Symbol.iterator</code>，为什么这里不需要收集呢，因为这里在实现时如果用到代理对象也会被收集到，而比如下面这段代码中，在具体的<code>Symbol</code>执行时也是在<code>effect</code>函数内，也会被收集到，而数组内也是通过下标来<code>get</code>也会收集到具体的<code>index</code>。</p>\n<pre><code class=\"language-js\"><span class=\"token keyword\">const</span> pig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  name<span class=\"token operator\">:</span> <span class=\"token string\">'猪'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">get</span> <span class=\"token punctuation\">[</span>Symbol<span class=\"token punctuation\">.</span>toStringTag<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token function\">effect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 经过[Symbol.toStringTag]函数收集到name属性依赖</span>\n  pig<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\npig<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token string\">'佩奇'</span>\n</code></pre>\n<p>&emsp;&emsp;当获取到的数据是<code>ref</code>数据时如果不是数组子项的话代理还会自动解包。不知道为啥设计成数组子项不自动解包，我猜测是因为防止<code>reactive([1, ref(2)])</code>使用时都是数字造成混乱。</p>\n<h4 id=\"array-改造器\">Array 改造器</h4>\n<p>&emsp;&emsp;当代理对象是<code>Array</code>时还需要还需要对一些的<code>api</code>做特殊处理，因为数组通过一些<code>api</code>获取会引发混乱，当用户使用<code>indexOf</code>、<code>lastIndexOf</code>、<code>includes</code>时因为底层是通过<code>this[index]</code>来获取的，<code>this</code>就是<code>proxy</code>，在<code>vue</code>中如果当前子项是对象会转化为代理，就会造成通过原始对象找不到在数组中的位置，比如没处理的话下方代码会出现这种情况</p>\n<pre><code class=\"language-js\"><span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> observed <span class=\"token operator\">=</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>target<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// -1, 因为比对的是 reactive(target) === target</span>\nobserved<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>&emsp;&emsp;在通过<code>push</code>、<code>pop</code>、<code>unshift</code>、<code>splice</code>写入和删除时底层会获取当前数组的<code>length</code>属性，如果在<code>effect</code>中使用时自然也会收集这个属性的依赖，当使用这些<code>api</code>是也会更改<code>length</code>，这时容易造成死循环，所以这些方法也需要特殊处理，比如没处理的话下方代码会出现这种情况</p>\n<pre><code class=\"language-js\"><span class=\"token keyword\">const</span> observed<span class=\"token operator\">:</span> number<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// e1: 采集到length依赖，并更改length</span>\n<span class=\"token function\">effect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  observed<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// e2: 采集到length依赖，并更改length，e1依赖length收到触发重新执行</span>\n<span class=\"token function\">effect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  observed<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// [ 1, 2, 1 ]</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>observed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>&emsp;&emsp;下面我们看看<code>Array</code>改造器源码</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// 数组的函数改造器</span>\n<span class=\"token keyword\">const</span> arrayInstrumentations <span class=\"token operator\">=</span> <span class=\"token comment\">/*#__PURE__*/</span> <span class=\"token function\">createArrayInstrumentations</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createArrayInstrumentations</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> instrumentations<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span>string<span class=\"token punctuation\">,</span> Function<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 需要对比获取源数据来比对的api</span>\n  <span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'includes'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'indexOf'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'lastIndexOf'</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">key</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    instrumentations<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args<span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 获取源数组</span>\n      <span class=\"token keyword\">const</span> arr <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> any\n      <span class=\"token comment\">// 因为不通过代理获取，所以需要手动track收集每个子项</span>\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> l <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> l<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">track</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">,</span> TrackOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">GET</span><span class=\"token punctuation\">,</span> i <span class=\"token operator\">+</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// 获取结果，如果获取不到结果，则将传入（可能传入代理）转换为源数据再次获取</span>\n      <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> arr<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>res <span class=\"token operator\">===</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span> res <span class=\"token operator\">===</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> arr<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>toRaw<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> res\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 为了某些情况会无限循环，对arry的length会改变的阻止收集</span>\n  <span class=\"token comment\">// 属于对数组的更改，但是写在effect时互相引用时会容易造成无限循环</span>\n  <span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'push'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'pop'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'shift'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'unshift'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'splice'</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">key</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    instrumentations<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args<span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 暂停收集</span>\n      <span class=\"token function\">pauseTracking</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// 通过源数组更改，不走代理</span>\n      <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// 恢复收集</span>\n      <span class=\"token function\">resetTracking</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> res\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> instrumentations\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>&emsp;&emsp;为了确保<code>indexOf</code>、<code>includes</code>、<code>lastIndexOf</code>等 api 能够获取到正确结果会将代理转化为<code>Target</code>对象，<code>api</code>传入对象先查找，如果查找不到再讲传入数据转化为<code>raw</code>查找比对。<code>push</code>, <code>pop</code>, <code>shift</code>, <code>unshift</code>, <code>splice</code>等 api 会在调用时暂停收集，因为他们本身也是更改数据，不用收集。</p>\n<p>&emsp;&emsp;<code>track</code>采用栈的方式管理，恢复是恢复上一次的状态，我们看一下源码</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// 当前是否开启跟踪</span>\n<span class=\"token keyword\">let</span> shouldTrack <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 跟踪栈</span>\n<span class=\"token keyword\">const</span> trackStack<span class=\"token operator\">:</span> boolean<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 暂停跟踪</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">pauseTracking</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  trackStack<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>shouldTrack<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  shouldTrack <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 启用跟踪</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">enableTracking</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  trackStack<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>shouldTrack<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  shouldTrack <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 恢复上一次跟踪，如果没有上一次默认为true</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">resetTracking</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> last <span class=\"token operator\">=</span> trackStack<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  shouldTrack <span class=\"token operator\">=</span> last <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">?</span> <span class=\"token boolean\">true</span> <span class=\"token operator\">:</span> last<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>&emsp;&emsp;到这里<code>get</code>拦截器就看完了，但是没有看到与<code>effect</code>关联的部分，都是统一<code>track</code>出去的，可以猜测到区分是否在<code>effect</code>中<code>get</code>应该是在<code>effect</code>这个函数中实现的，这个我们后面再讲。</p>\n<h3 id=\"set-拦截器和-delete-拦截器\">set 拦截器和 delete 拦截器</h3>\n<p>&emsp;&emsp;在思考实现时我们说到<code>set</code>拦截器主要职责是重新触发<code>effect</code>的执行，在<code>vue</code>中是使用<code>trigger</code>这个函数来实现的，<code>delete</code>拦截器也是属于修改同样的职责，接下来我们看看<code>createSetter</code>和<code>deleteProperty</code>函数源码：</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// 创建set 拦截器</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createSetter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">shallow <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">set</span><span class=\"token punctuation\">(</span>\n    <span class=\"token parameter\">target<span class=\"token operator\">:</span> object<span class=\"token punctuation\">,</span>\n    key<span class=\"token operator\">:</span> string <span class=\"token operator\">|</span> symbol<span class=\"token punctuation\">,</span>\n    value<span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">,</span>\n    receiver<span class=\"token operator\">:</span> object</span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> boolean <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 获取旧数据</span>\n    <span class=\"token keyword\">let</span> oldValue <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>target <span class=\"token keyword\">as</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n    <span class=\"token comment\">// 如果当前不是shallow并且不是只读的</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>shallow <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">isReadonly</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 获取target属性，如reacitve(ref(1))获取回来就是ref(1)</span>\n      value <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n      oldValue <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>oldValue<span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// 并且target不是数组并且旧数据是ref,新数据不是则直接赋值value</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">isRef</span><span class=\"token punctuation\">(</span>oldValue<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">isRef</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        oldValue<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> value\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 查看当前更新key是否存在</span>\n    <span class=\"token keyword\">const</span> hadKey <span class=\"token operator\">=</span>\n      <span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">isIntegerKey</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">?</span> <span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> target<span class=\"token punctuation\">.</span>length\n        <span class=\"token operator\">:</span> <span class=\"token function\">hasOwn</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> receiver<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 如果是通过原型链触发的修改，则不trigger</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>target <span class=\"token operator\">===</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>receiver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 查看是否存在，存在是否修改，再触发trigger</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hadKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">ADD</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">hasChanged</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> oldValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">SET</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> oldValue<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> result\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// del 代理器</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">deleteProperty</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token operator\">:</span> object<span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> string <span class=\"token operator\">|</span> symbol</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> boolean <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> hadKey <span class=\"token operator\">=</span> <span class=\"token function\">hasOwn</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> oldValue <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>target <span class=\"token keyword\">as</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">deleteProperty</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">&amp;&amp;</span> hadKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">DELETE</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> oldValue<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> result\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>&emsp;&emsp;<code>set</code>和<code>delete</code>拦截器相对于<code>get</code>拦截器就简单很多了，<code>set</code>和<code>delete</code>拦截器是可读写代理进入的，主要是修改，新增还是删除属性，当<code>trigger</code>时把具体细节传出。<code>set</code>还会自动解包<code>ref</code>并赋值。</p>\n<p>&emsp;&emsp;<code>set</code>时如果是<code>shallow</code>或者<code>readonly</code>类型时不做任何处理，直接保持原样设置。如果<code>Target</code>不是数组，旧值是<code>ref</code>新值不是，则直接更新旧值<code>ref</code>的<code>value</code>，这里为什么不用<code>trigger</code>直接返回，这是是因为<code>ref</code>里面已经<code>trigger</code>了，关于<code>ref</code>的实现我们下一章再讲。</p>\n<p>&emsp;&emsp;注意：<b>如果是数组，不管是不是下标属性，都是直接赋值，不会解包</b>。上面<code>get</code>拦截器解包逻辑不太一样，<code>get</code>拦截器中如果是数组，非下标会解包，而<code>set</code>拦截器不管是不是下标都不会解包，也就是说会出现下面这种情况，使用感觉不出来，但是还是要注意一下。</p>\n<pre><code class=\"language-js\"><span class=\"token keyword\">const</span> observed1 <span class=\"token operator\">=</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span> any<span class=\"token punctuation\">)</span>\nobserved1<span class=\"token punctuation\">.</span>_a <span class=\"token operator\">=</span> <span class=\"token function\">ref</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// observed._a 时会自动解包 返回2 实际上存储的是 ref(2)</span>\nobserved1<span class=\"token punctuation\">.</span>_a <span class=\"token operator\">=</span> <span class=\"token number\">4</span>\n<span class=\"token comment\">// observed._a 返回4 实际上存储的是4</span>\n\n<span class=\"token keyword\">const</span> observed2 <span class=\"token operator\">=</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token keyword\">as</span> any<span class=\"token punctuation\">)</span>\nobserved2<span class=\"token punctuation\">.</span>_a <span class=\"token operator\">=</span> <span class=\"token function\">ref</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// observed._a 时会自动解包 返回2 实际上存储的是 ref(2)</span>\nobserved2<span class=\"token punctuation\">.</span>_a <span class=\"token operator\">=</span> <span class=\"token number\">4</span>\n<span class=\"token comment\">// observed._a 时会自动解包 返回4 实际上存储的是 ref(4)</span>\n</code></pre>\n<p>&emsp;&emsp;上面有段<code>target === toRaw(receiver)</code>来区分是否是原型上触发的判断，它为什么能区分出是否是原型呢，因为在<code>set</code>拦截器中第四个参数是指向当前操作者的<code>this</code>的，假如代理是附加在某个对象的原型上，那么指向的就是这个对象而不是代理。</p>\n<h3 id=\"has-拦截器和-ownkeys-拦截器\">has 拦截器和 ownKeys 拦截器</h3>\n<p>&emsp;&emsp;<code>has</code>拦截器和<code>ownKeys</code>拦截器主要职责也是<code>track</code>，告诉<code>vue</code>依赖了哪些属性，与<code>get</code>拦截器一样内置的<code>Symbol</code>不做收集。当<code>Target</code>是数组时触发的<code>ownKeys</code>拦截器会将当前收集的 key 当做是<code>length</code>属性变化，这是因为用户可能在<code>effect</code>中使用<code>array.length</code>和<code>for (const atom of array)</code>，可以统一使用<code>length</code>一个属性来标识，这样当<code>length</code>改变时统一通知就可以了，如果<code>for (const atom of array)</code>使用<code>ITERATE_KEY</code>会触发两次，一次时<code>length</code>修改，一次时<code>ITERATE_KEY</code>修改。</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// has 拦截器</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">has</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token operator\">:</span> object<span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> string <span class=\"token operator\">|</span> symbol</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> boolean <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 查看是否是内置的symbol如果是则不track</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isSymbol</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>builtInSymbols<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">track</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TrackOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">HAS</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// getOwnPropertyNames getOwnPropertySymbols keys 拦截器</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">ownKeys</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token operator\">:</span> object</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>string <span class=\"token operator\">|</span> symbol<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">track</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TrackOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">ITERATE</span><span class=\"token punctuation\">,</span> <span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token string\">\"length\"</span> <span class=\"token operator\">:</span> <span class=\"token constant\">ITERATE_KEY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">ownKeys</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h2 id=\"集合拦截器\">集合拦截器</h2>\n<p>&emsp;&emsp;在上面我们讲到因为<code>Proxy</code><a href=\"https://bill-lai.github.io/article/d6de1bf5f0382cf53f5e/#%E4%BB%A3%E7%90%86%E5%85%B7%E6%9C%89%E7%A7%81%E6%9C%89%E5%B1%9E%E6%80%A7%E7%9A%84%E5%AF%B9%E8%B1%A1\">代理具有内部插槽的内建对象</a>时和集合获取和存储数据时的限制，所以必须将拦截器与普通对象区分出来。如果是你你会怎么实现呢？</p>\n<p>&emsp;&emsp;其实在上面代理<code>Array</code>时已经有例子了，既然只能拦截到方法和属性，那么我们就通过改写集合<code>Proxy</code>上的方法和属性来实现就行了，下面我们列出集合上的所有的方法和属性，并标注我们需要做的事情。</p>\n<table>\n<thead>\n<tr>\n<th>方法和属性</th>\n<th>Map</th>\n<th>WeakMap</th>\n<th>Set</th>\n<th>WeakSet</th>\n<th>操作</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>get</td>\n<td>Y</td>\n<td>Y</td>\n<td>N</td>\n<td>N</td>\n<td><code>track</code>，类型：<code>GET</code>，<code>key</code>：用户传入</td>\n</tr>\n<tr>\n<td>size</td>\n<td>Y</td>\n<td>N</td>\n<td>Y</td>\n<td>N</td>\n<td><code>track</code>，类型：<code>ITERATE</code>，<code>key</code>：<code>ITERATE_KEY</code></td>\n</tr>\n<tr>\n<td>has</td>\n<td>Y</td>\n<td>Y</td>\n<td>Y</td>\n<td>Y</td>\n<td><code>track</code>，类型：<code>HAS</code>，<code>key</code>：用户传入</td>\n</tr>\n<tr>\n<td>add</td>\n<td>N</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n<td><code>trigger</code>，类型: <code>ADD</code>，<code>key</code>：用户传入<em>（<code>set</code>中<code>key</code>就是<code>value</code>）</em></td>\n</tr>\n<tr>\n<td>set</td>\n<td>Y</td>\n<td>Y</td>\n<td>N</td>\n<td>N</td>\n<td><code>trigger</code>，类型: <code>SET</code>或<code>ADD</code>，<code>key</code>：用户传入</td>\n</tr>\n<tr>\n<td>delete</td>\n<td>Y</td>\n<td>Y</td>\n<td>Y</td>\n<td>Y</td>\n<td><code>trigger</code>，类型: <code>DELETE</code>，<code>key</code>：用户传入</td>\n</tr>\n<tr>\n<td>clear</td>\n<td>Y</td>\n<td>N</td>\n<td>Y</td>\n<td>N</td>\n<td><code>trigger</code>，类型: <code>CLEAR</code>，<code>key</code>：<code>undefined</code></td>\n</tr>\n<tr>\n<td>forEach</td>\n<td>Y</td>\n<td>N</td>\n<td>Y</td>\n<td>N</td>\n<td><code>track</code>，类型：<code>ITERATE</code>，<code>key</code>：<code>ITERATE_KEY</code></td>\n</tr>\n<tr>\n<td>keys</td>\n<td>Y</td>\n<td>N</td>\n<td>Y</td>\n<td>N</td>\n<td><code>track</code>，类型：<code>ITERATE</code>，<code>key</code>：<code>MAP_KEY_ITERATE_KEY</code></td>\n</tr>\n<tr>\n<td>values</td>\n<td>Y</td>\n<td>N</td>\n<td>Y</td>\n<td>N</td>\n<td><code>track</code>，类型：<code>ITERATE</code>，<code>key</code>：<code>ITERATE_KEY</code></td>\n</tr>\n<tr>\n<td>entries</td>\n<td>Y</td>\n<td>N</td>\n<td>Y</td>\n<td>N</td>\n<td><code>track</code>，类型：<code>ITERATE</code>，<code>key</code>：<code>ITERATE_KEY</code></td>\n</tr>\n<tr>\n<td>Symbol.iterator</td>\n<td>Y</td>\n<td>N</td>\n<td>Y</td>\n<td>N</td>\n<td><code>track</code>，类型：<code>ITERATE</code>，<code>key</code>：<code>ITERATE_KEY</code></td>\n</tr>\n</tbody></table>\n<p>&emsp;&emsp;在上面中我们看到常用拦截器有四种分别是<code>mutableCollectionHandlers</code>、<code>readonlyCollectionHandlers</code>、<code>shallowCollectionHandlers</code>、<code>shallowReadonlyCollectionHandlers</code>分别对应<code>reactive</code>、<code>readonly</code>、<code>shallowReactive</code>、<code>shallowReadonly</code>集合代理类型接下来我们看看源码实现：</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// 创建集合get拦截器，附加flags，和改造api</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createInstrumentationGetter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">isReadonly<span class=\"token operator\">:</span> boolean<span class=\"token punctuation\">,</span> shallow<span class=\"token operator\">:</span> boolean</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 获取各个版本的修改器</span>\n  <span class=\"token keyword\">const</span> instrumentations <span class=\"token operator\">=</span> shallow\n    <span class=\"token operator\">?</span> isReadonly\n      <span class=\"token operator\">?</span> shallowReadonlyInstrumentations\n      <span class=\"token operator\">:</span> shallowInstrumentations\n    <span class=\"token operator\">:</span> isReadonly\n    <span class=\"token operator\">?</span> readonlyInstrumentations\n    <span class=\"token operator\">:</span> mutableInstrumentations<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token parameter\">target<span class=\"token operator\">:</span> CollectionTypes<span class=\"token punctuation\">,</span>\n    key<span class=\"token operator\">:</span> string <span class=\"token operator\">|</span> symbol<span class=\"token punctuation\">,</span>\n    receiver<span class=\"token operator\">:</span> CollectionTypes</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">===</span> ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">IS_REACTIVE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span>isReadonly<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">===</span> ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">IS_READONLY</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> isReadonly<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">===</span> ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">RAW</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 使用拦截器返回用户使用函数</span>\n    <span class=\"token keyword\">return</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>\n      <span class=\"token function\">hasOwn</span><span class=\"token punctuation\">(</span>instrumentations<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> key <span class=\"token keyword\">in</span> target\n        <span class=\"token operator\">?</span> instrumentations\n        <span class=\"token operator\">:</span> target<span class=\"token punctuation\">,</span>\n      key<span class=\"token punctuation\">,</span>\n      receiver\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> mutableCollectionHandlers<span class=\"token operator\">:</span> ProxyHandler<span class=\"token operator\">&lt;</span>CollectionTypes<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  get<span class=\"token operator\">:</span> <span class=\"token comment\">/*#__PURE__*/</span> <span class=\"token function\">createInstrumentationGetter</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> shallowCollectionHandlers<span class=\"token operator\">:</span> ProxyHandler<span class=\"token operator\">&lt;</span>CollectionTypes<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  get<span class=\"token operator\">:</span> <span class=\"token comment\">/*#__PURE__*/</span> <span class=\"token function\">createInstrumentationGetter</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> readonlyCollectionHandlers<span class=\"token operator\">:</span> ProxyHandler<span class=\"token operator\">&lt;</span>CollectionTypes<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  get<span class=\"token operator\">:</span> <span class=\"token comment\">/*#__PURE__*/</span> <span class=\"token function\">createInstrumentationGetter</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> shallowReadonlyCollectionHandlers<span class=\"token operator\">:</span> ProxyHandler<span class=\"token operator\">&lt;</span>CollectionTypes<span class=\"token operator\">></span> <span class=\"token operator\">=</span>\n  <span class=\"token punctuation\">{</span>\n    get<span class=\"token operator\">:</span> <span class=\"token comment\">/*#__PURE__*/</span> <span class=\"token function\">createInstrumentationGetter</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>&emsp;&emsp;和我们猜想一样，<code>vue</code>只代理了集合的<code>get</code>，因为无法拦截<code>set</code>，所以通过修改方法和属性可以将我们需要做的操作附加上去。通过闭包将是否只读，是否是<code>shallow</code>缓存，并生成相对应的修改器。</p>\n<p>&emsp;&emsp;跟常用拦截器一样也会为集合<code>Proxy</code>附加上各个<code>flags</code>属性。当获取某个属性时，如果这个属性是在修改器对象上，并且也在当前集合上，那么就会从修改器中获取这个方法或者属性返回。为什么还要获取是否在是否在集合上呢，因为修改器是通过<code>Proxy</code>类型分类的，而不是通过集合类型分类的，那么修改器中可能会同时存在<code>add</code>、<code>set</code>，如果不判断一遍是否存在集合上那么<code>map.add</code>也会调用到修改器中的<code>add</code>方法。接下来我们看看创建修改器的具体实现。</p>\n<pre><code class=\"language-js\"><span class=\"token comment\">// 只读版本修改方法，只弹出警告</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createReadonlyMethod</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token operator\">:</span> TriggerOpTypes</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Function <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> CollectionTypes<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args<span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>__DEV__<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">?</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">on key \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\" </span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token template-punctuation string\">`</span></span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span>\n        <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">capitalize</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> operation </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>key<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">failed: target is readonly.</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n        <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> type <span class=\"token operator\">===</span> TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">DELETE</span> <span class=\"token operator\">?</span> <span class=\"token boolean\">false</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">this</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 创建各个版本的拦截处理器</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createInstrumentations</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> mutableInstrumentations<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span>string<span class=\"token punctuation\">,</span> Function<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> MapTypes<span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">get</span> <span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token keyword\">as</span> unknown <span class=\"token keyword\">as</span> IterableCollections<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    has<span class=\"token punctuation\">,</span>\n    add<span class=\"token punctuation\">,</span>\n    set<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">delete</span><span class=\"token operator\">:</span> deleteEntry<span class=\"token punctuation\">,</span>\n    clear<span class=\"token punctuation\">,</span>\n    forEach<span class=\"token operator\">:</span> <span class=\"token function\">createForEach</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> shallowInstrumentations<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span>string<span class=\"token punctuation\">,</span> Function<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> MapTypes<span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">get</span> <span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token keyword\">as</span> unknown <span class=\"token keyword\">as</span> IterableCollections<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    has<span class=\"token punctuation\">,</span>\n    add<span class=\"token punctuation\">,</span>\n    set<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">delete</span><span class=\"token operator\">:</span> deleteEntry<span class=\"token punctuation\">,</span>\n    clear<span class=\"token punctuation\">,</span>\n    forEach<span class=\"token operator\">:</span> <span class=\"token function\">createForEach</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> readonlyInstrumentations<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span>string<span class=\"token punctuation\">,</span> Function<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> MapTypes<span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">get</span> <span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token keyword\">as</span> unknown <span class=\"token keyword\">as</span> IterableCollections<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">has</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> MapTypes<span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> unknown</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">has</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    add<span class=\"token operator\">:</span> <span class=\"token function\">createReadonlyMethod</span><span class=\"token punctuation\">(</span>TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">ADD</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    set<span class=\"token operator\">:</span> <span class=\"token function\">createReadonlyMethod</span><span class=\"token punctuation\">(</span>TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">SET</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">delete</span><span class=\"token operator\">:</span> <span class=\"token function\">createReadonlyMethod</span><span class=\"token punctuation\">(</span>TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">DELETE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    clear<span class=\"token operator\">:</span> <span class=\"token function\">createReadonlyMethod</span><span class=\"token punctuation\">(</span>TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">CLEAR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    forEach<span class=\"token operator\">:</span> <span class=\"token function\">createForEach</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> shallowReadonlyInstrumentations<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span>string<span class=\"token punctuation\">,</span> Function<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> MapTypes<span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">get</span> <span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token keyword\">as</span> unknown <span class=\"token keyword\">as</span> IterableCollections<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">has</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> MapTypes<span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> unknown</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">has</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    add<span class=\"token operator\">:</span> <span class=\"token function\">createReadonlyMethod</span><span class=\"token punctuation\">(</span>TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">ADD</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    set<span class=\"token operator\">:</span> <span class=\"token function\">createReadonlyMethod</span><span class=\"token punctuation\">(</span>TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">SET</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">delete</span><span class=\"token operator\">:</span> <span class=\"token function\">createReadonlyMethod</span><span class=\"token punctuation\">(</span>TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">DELETE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    clear<span class=\"token operator\">:</span> <span class=\"token function\">createReadonlyMethod</span><span class=\"token punctuation\">(</span>TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">CLEAR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    forEach<span class=\"token operator\">:</span> <span class=\"token function\">createForEach</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 各个迭代器拦截器</span>\n  <span class=\"token keyword\">const</span> iteratorMethods <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'keys'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'values'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'entries'</span><span class=\"token punctuation\">,</span> Symbol<span class=\"token punctuation\">.</span>iterator<span class=\"token punctuation\">]</span>\n  iteratorMethods<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">method</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    mutableInstrumentations<span class=\"token punctuation\">[</span>method <span class=\"token keyword\">as</span> string<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">createIterableMethod</span><span class=\"token punctuation\">(</span>\n      method<span class=\"token punctuation\">,</span>\n      <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n      <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">)</span>\n    readonlyInstrumentations<span class=\"token punctuation\">[</span>method <span class=\"token keyword\">as</span> string<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">createIterableMethod</span><span class=\"token punctuation\">(</span>\n      method<span class=\"token punctuation\">,</span>\n      <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">)</span>\n    shallowInstrumentations<span class=\"token punctuation\">[</span>method <span class=\"token keyword\">as</span> string<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">createIterableMethod</span><span class=\"token punctuation\">(</span>\n      method<span class=\"token punctuation\">,</span>\n      <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n      <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">)</span>\n    shallowReadonlyInstrumentations<span class=\"token punctuation\">[</span>method <span class=\"token keyword\">as</span> string<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">createIterableMethod</span><span class=\"token punctuation\">(</span>\n      method<span class=\"token punctuation\">,</span>\n      <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n    mutableInstrumentations<span class=\"token punctuation\">,</span>\n    readonlyInstrumentations<span class=\"token punctuation\">,</span>\n    shallowInstrumentations<span class=\"token punctuation\">,</span>\n    shallowReadonlyInstrumentations\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>\n  mutableInstrumentations<span class=\"token punctuation\">,</span>\n  readonlyInstrumentations<span class=\"token punctuation\">,</span>\n  shallowInstrumentations<span class=\"token punctuation\">,</span>\n  shallowReadonlyInstrumentations\n<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token comment\">/* #__PURE__*/</span> <span class=\"token function\">createInstrumentations</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<p>&emsp;&emsp;可以看到构建时大部分方法都是公用的，只是传入参数不同为了区分<code>readonly</code>、<code>shallow</code>。只读版本的<code>Proxy</code>做增删改时都是弹出警告。所以真实的实现只有<code>get</code>、<code>has</code>、<code>size</code>、<code>set</code>、<code>add</code>、<code>delete</code>、<code>clear</code>、<code>createForEach</code>、<code>createIterableMethod</code>等函数。</p>\n<p>&emsp;&emsp;<code>keys</code>, <code>values</code>, <code>entries</code>, <code>Symbol.iterator</code>，都使用<code>createIterableMethod</code>来构建的，为了区分还会将当前的<code>method</code>传入。</p>\n<p>&emsp;&emsp;其中集合的<code>size</code>是属性，为了能够附加操作还将它改造成<code>getter</code>函数。</p>\n<h3 id=\"get-修改器、size-修改器和-has-修改器\">get 修改器、size 修改器和 has 修改器</h3>\n<pre><code class=\"language-js\"><span class=\"token comment\">// 辅助方法，转化为shallow 什么都不做</span>\n<span class=\"token keyword\">const</span> toShallow <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">unknown</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>value<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token parameter\"><span class=\"token constant\">T</span></span> <span class=\"token operator\">=></span> value\n\n<span class=\"token comment\">// get拦截器</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">target<span class=\"token operator\">:</span> MapTypes<span class=\"token punctuation\">,</span>\n  key<span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">,</span>\n  isReadonly <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  isShallow <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 如果出现readonly(reactive(Map)) 的情况，在readonly代理中获取到reactive(Map)，</span>\n  <span class=\"token comment\">// 确保get时也要经过reactive代理</span>\n  target <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>target <span class=\"token keyword\">as</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">RAW</span><span class=\"token punctuation\">]</span>\n  <span class=\"token comment\">// 获取 target</span>\n  <span class=\"token keyword\">const</span> rawTarget <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 获取 key target</span>\n  <span class=\"token keyword\">const</span> rawKey <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 如果key是响应式的</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!==</span> rawKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 再track收集一遍响应式key</span>\n    <span class=\"token comment\">// 那么用户不管 trigger的是rawKey 还是 key都会触发得到</span>\n    <span class=\"token operator\">!</span>isReadonly <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">track</span><span class=\"token punctuation\">(</span>rawTarget<span class=\"token punctuation\">,</span> TrackOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">GET</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 收集访问了哪个key</span>\n  <span class=\"token operator\">!</span>isReadonly <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">track</span><span class=\"token punctuation\">(</span>rawTarget<span class=\"token punctuation\">,</span> TrackOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">GET</span><span class=\"token punctuation\">,</span> rawKey<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 获取集合原型上的has方法</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> has <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">getProto</span><span class=\"token punctuation\">(</span>rawTarget<span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 获取返回值处理函数，根据当前代理类型，将返回值转化为相对应的代理类型</span>\n  <span class=\"token keyword\">const</span> wrap <span class=\"token operator\">=</span> isShallow <span class=\"token operator\">?</span> toShallow <span class=\"token operator\">:</span> isReadonly <span class=\"token operator\">?</span> toReadonly <span class=\"token operator\">:</span> toReactive\n\n  <span class=\"token comment\">// 确保 包装后的key 和没包装的key都能访问得到</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">has</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>rawTarget<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">wrap</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">has</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>rawTarget<span class=\"token punctuation\">,</span> rawKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">wrap</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>rawKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>target <span class=\"token operator\">!==</span> rawTarget<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 如果target !== rawTarget,那么就是如果出现readonly(reactive(Map))的情况，</span>\n    <span class=\"token comment\">// 确保也要经过reactive代理处理</span>\n    target<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// has 拦截器 是否shallow处理方式都一样</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">has</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> CollectionTypes<span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">,</span> isReadonly <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> boolean <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 获取代理前数据</span>\n  <span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token keyword\">as</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">RAW</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> rawTarget <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> rawKey <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 如果key是响应式的都收集一遍</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">!==</span> rawKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">!</span>isReadonly <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">track</span><span class=\"token punctuation\">(</span>rawTarget<span class=\"token punctuation\">,</span> TrackOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">HAS</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">!</span>isReadonly <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">track</span><span class=\"token punctuation\">(</span>rawTarget<span class=\"token punctuation\">,</span> TrackOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">HAS</span><span class=\"token punctuation\">,</span> rawKey<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 如果key是proxy, 那么先获取has(keyProxy),再获取has(key)确保获取结果正确</span>\n  <span class=\"token keyword\">return</span> key <span class=\"token operator\">===</span> rawKey\n    <span class=\"token operator\">?</span> target<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">:</span> target<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> target<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>rawKey<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// size 拦截器 是否shallow处理方式都一样</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token operator\">:</span> IterableCollections<span class=\"token punctuation\">,</span> isReadonly <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 获取封装对象</span>\n  target <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>target <span class=\"token keyword\">as</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">RAW</span><span class=\"token punctuation\">]</span>\n  <span class=\"token comment\">// 收集获取迭代</span>\n  <span class=\"token operator\">!</span>isReadonly <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">track</span><span class=\"token punctuation\">(</span><span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> TrackOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">ITERATE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">ITERATE_KEY</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> <span class=\"token string\">'size'</span><span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n</code></pre>\n<p>&emsp;&emsp;和常用拦截器附加逻辑差不多，和将获取的值转化为当前<code>proxy</code>类型的<code>proxy</code>，<code>track</code>依赖，不过有细微的区别。</p>\n<p>&emsp;&emsp;看到<code>(target as any)[ReactiveFlags.RAW]</code>会获取当前代理前的数据，这是为了防止<code>readonly(reactive(Map))</code>类型的代理获取的值返回的是<code>readonly</code>类型的代理，所以获取<code>readonly</code>前的数据也就是<code>reactive(Map)</code>进行<code>get</code>这样获取也会经过<code>reactive</code>代理修改器，获取回来的就是<code>toReadonly(toReactive(Raw))</code>。为什么常用处理器不用呢，因为它是通过代理拦截器的第一个参数直接获取的，就是代理前的数据。</p>\n<p>&emsp;&emsp;还有当<code>Map</code>和<code>WeakMap</code>获取数据是，会检测<code>key</code>是否是<code>Proxy</code>，如果是的话，会<code>track</code>两次，这是因为<code>Map</code>和<code>WeakMap</code>的<code>key</code>可以是对象，用户可能将<code>Proxy</code>当做<code>key</code>，当然在<code>set</code>的时候会将<code>key</code>转化为原始数据存储，但是在初始化的时候不会做检测，所以为了确保能正确的触发，两次收集时必要的，否则当存储是<code>proxy</code>的<code>key</code>的话将无法触发。例如：</p>\n<pre><code class=\"language-js\"><span class=\"token keyword\">const</span> map <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nmap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> rMap <span class=\"token operator\">=</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">effect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  map<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 如果没有收集到 keyProxy的话将无法触发</span>\nmap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h3 id=\"set-修改器、delete-修改器和-clear-修改器\">set 修改器、delete 修改器和 clear 修改器</h3>\n<pre><code class=\"language-js\"><span class=\"token comment\">// 检查key是否是响应式的</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">checkIdentityKeys</span><span class=\"token punctuation\">(</span>\n  target<span class=\"token operator\">:</span> CollectionTypes<span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">has</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">key<span class=\"token operator\">:</span> unknown</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> boolean<span class=\"token punctuation\">,</span>\n  key<span class=\"token operator\">:</span> unknown\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> rawKey <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rawKey <span class=\"token operator\">!==</span> key <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">has</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> rawKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> type <span class=\"token operator\">=</span> <span class=\"token function\">toRawType</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span>\n      <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Reactive </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>type<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> contains both the raw and reactive </span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token operator\">+</span>\n        <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">versions of the same object</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>type <span class=\"token operator\">===</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Map</span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token operator\">?</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\"> as keys</span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">, </span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token operator\">+</span>\n        <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">which can lead to inconsistencies. </span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token operator\">+</span>\n        <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Avoid differentiating between the raw and reactive versions </span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token operator\">+</span>\n        <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">of an object and only use the reactive version if possible.</span><span class=\"token template-punctuation string\">`</span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Map set处理器</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> MapTypes<span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> unknown</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 存origin value</span>\n  value <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 获取origin target</span>\n  <span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> has<span class=\"token punctuation\">,</span> get <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">getProto</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 查看当前key是否存在</span>\n  <span class=\"token keyword\">let</span> hadKey <span class=\"token operator\">=</span> <span class=\"token function\">has</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 如果不存在则获取 origin</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hadKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    key <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    hadKey <span class=\"token operator\">=</span> <span class=\"token function\">has</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>__DEV__<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 检查当前是否包含原始版本 和响应版本在target中</span>\n    <span class=\"token function\">checkIdentityKeys</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> has<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 获取旧的value</span>\n  <span class=\"token keyword\">const</span> oldValue <span class=\"token operator\">=</span> <span class=\"token function\">get</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 设置新值</span>\n  target<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hadKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">ADD</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">hasChanged</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> oldValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">SET</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> oldValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Set add拦截器</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> SetTypes<span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> unknown</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 存origin value</span>\n  value <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 获取origin target</span>\n  <span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> proto <span class=\"token operator\">=</span> <span class=\"token function\">getProto</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 查看是否存在要添加的value</span>\n  <span class=\"token keyword\">const</span> hadKey <span class=\"token operator\">=</span> proto<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 不存在添加，并且trigger</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hadKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    target<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">ADD</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// clear拦截器</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> IterableCollections</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 获取是否存在数据</span>\n  <span class=\"token keyword\">const</span> hadItems <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>size <span class=\"token operator\">!==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 构建一个map set作为旧数据</span>\n  <span class=\"token keyword\">const</span> oldTarget <span class=\"token operator\">=</span> __DEV__\n    <span class=\"token operator\">?</span> <span class=\"token function\">isMap</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">?</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hadItems<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">CLEAR</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> oldTarget<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>&emsp;&emsp;这些修改器也和我们猜想的差不多，主要职责是<code>trigger</code>。并且会确保<code>set</code>和<code>add</code>进去的值是<code>Target</code>而不是<code>Proxy</code>。其中<code>Map</code>和<code>WeakMap</code>的<code>set</code>修改器还会检测当前<code>key</code>是否存储了两份版本即是<code>proxy</code>和原始版本的<code>key</code>，如果有的话则弹出警告。<code>Set</code>和<code>WeakSet</code>的<code>add</code>修改器会检测当前是否存在，如果存在则不在触发因为<code>Set</code>内不是会有重复数据的。</p>\n<h3 id=\"createforeach-修改器和-createiterablemethod-修改器\">createForEach 修改器和 createIterableMethod 修改器</h3>\n<pre><code class=\"language-js\"><span class=\"token comment\">// forEach拦截器</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createForEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">isReadonly<span class=\"token operator\">:</span> boolean<span class=\"token punctuation\">,</span> isShallow<span class=\"token operator\">:</span> boolean</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>\n    <span class=\"token parameter\"><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> IterableCollections<span class=\"token punctuation\">,</span>\n    callback<span class=\"token operator\">:</span> Function<span class=\"token punctuation\">,</span>\n    thisArg<span class=\"token operator\">?</span><span class=\"token operator\">:</span> unknown</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> observed <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span> <span class=\"token keyword\">as</span> any\n    <span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> observed<span class=\"token punctuation\">[</span>ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">RAW</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">const</span> rawTarget <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 转化器</span>\n    <span class=\"token keyword\">const</span> wrap <span class=\"token operator\">=</span> isShallow <span class=\"token operator\">?</span> toShallow <span class=\"token operator\">:</span> isReadonly <span class=\"token operator\">?</span> toReadonly <span class=\"token operator\">:</span> toReactive\n    <span class=\"token comment\">// track当前</span>\n    <span class=\"token operator\">!</span>isReadonly <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">track</span><span class=\"token punctuation\">(</span>rawTarget<span class=\"token punctuation\">,</span> TrackOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">ITERATE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">ITERATE_KEY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// origin foreach</span>\n    <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value<span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> unknown</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 确保用户拿到的值是响应式的</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>thisArg<span class=\"token punctuation\">,</span> <span class=\"token function\">wrap</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">wrap</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> observed<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 创建迭代器拦截器  keys values Symbol.interator使用</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createIterableMethod</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">method<span class=\"token operator\">:</span> string <span class=\"token operator\">|</span> symbol<span class=\"token punctuation\">,</span>\n  isReadonly<span class=\"token operator\">:</span> boolean<span class=\"token punctuation\">,</span>\n  isShallow<span class=\"token operator\">:</span> boolean</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 返回迭代器</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token parameter\"><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> IterableCollections<span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">...</span>args<span class=\"token operator\">:</span> unknown<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Iterable <span class=\"token operator\">&amp;</span> Iterator <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 获取封装对象</span>\n    <span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token keyword\">as</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">RAW</span><span class=\"token punctuation\">]</span>\n    <span class=\"token comment\">// 源对象 </span>\n    <span class=\"token keyword\">const</span> rawTarget <span class=\"token operator\">=</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 是否是map</span>\n    <span class=\"token keyword\">const</span> targetIsMap <span class=\"token operator\">=</span> <span class=\"token function\">isMap</span><span class=\"token punctuation\">(</span>rawTarget<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 是否需要返回一对[key, val]</span>\n    <span class=\"token keyword\">const</span> isPair <span class=\"token operator\">=</span>\n      method <span class=\"token operator\">===</span> <span class=\"token string\">'entries'</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>method <span class=\"token operator\">===</span> Symbol<span class=\"token punctuation\">.</span>iterator <span class=\"token operator\">&amp;&amp;</span> targetIsMap<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 是否只需要返回key</span>\n    <span class=\"token keyword\">const</span> isKeyOnly <span class=\"token operator\">=</span> method <span class=\"token operator\">===</span> <span class=\"token string\">'keys'</span> <span class=\"token operator\">&amp;&amp;</span> targetIsMap\n    <span class=\"token comment\">// 获取封装对象迭代器</span>\n    <span class=\"token keyword\">const</span> innerIterator <span class=\"token operator\">=</span> target<span class=\"token punctuation\">[</span>method<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 转化函数</span>\n    <span class=\"token keyword\">const</span> wrap <span class=\"token operator\">=</span> isShallow <span class=\"token operator\">?</span> toShallow <span class=\"token operator\">:</span> isReadonly <span class=\"token operator\">?</span> toReadonly <span class=\"token operator\">:</span> toReactive\n    <span class=\"token comment\">// track当前对象</span>\n    <span class=\"token operator\">!</span>isReadonly <span class=\"token operator\">&amp;&amp;</span>\n      <span class=\"token function\">track</span><span class=\"token punctuation\">(</span>\n        rawTarget<span class=\"token punctuation\">,</span>\n        TrackOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">ITERATE</span><span class=\"token punctuation\">,</span>\n        isKeyOnly <span class=\"token operator\">?</span> <span class=\"token constant\">MAP_KEY_ITERATE_KEY</span> <span class=\"token operator\">:</span> <span class=\"token constant\">ITERATE_KEY</span>\n      <span class=\"token punctuation\">)</span>\n      \n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 迭代器直接使用</span>\n      <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 直接使用封装对象迭代器，再转化为响应式版本</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> value<span class=\"token punctuation\">,</span> done <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> innerIterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> done\n          <span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span> value<span class=\"token punctuation\">,</span> done <span class=\"token punctuation\">}</span>\n          <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n              value<span class=\"token operator\">:</span> isPair <span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span><span class=\"token function\">wrap</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">wrap</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token function\">wrap</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n              done\n            <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// 给 keys values entries 方法调用时创建迭代器</span>\n      <span class=\"token punctuation\">[</span>Symbol<span class=\"token punctuation\">.</span>iterator<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>&emsp;&emsp;我们先看看<code>forEach</code>修改器的实现，这里会将获取的每个<code>key</code>，<code>value</code>都转化为相对应的代理，确保用户通过<code>Proxy</code>获取的都是<code>Proxy</code>，也相对比较简单。</p>\n<p>&emsp;&emsp;在看迭代器修改器前我们先回忆一下迭代器对象的实现方式，首先迭代器对象上必须返回带有<code>Symbol.iterator</code>方法，这个方法必须有<code>next</code>方法，<code>next</code>方法需要放回带有<code>value</code>和<code>done</code>属性的对象，当<code>done</code>为<code>true</code>时表示完成迭代到达边界，下面我们实现一个简单的迭代器对象：</p>\n<pre><code class=\"language-js\"><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n<span class=\"token keyword\">const</span> test <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">[</span>Symbol<span class=\"token punctuation\">.</span>iterator<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            value<span class=\"token operator\">:</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">,</span>\n            done<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            done<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// [0,1,2,3,4]</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>test<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<p>&emsp;&emsp;接下来我们再看迭代器修改器的实现，<code>keys</code>, <code>values</code>, <code>entries</code>, 等方法都有一个共同的特征就是返回的是迭代器对象，所以当执行的时候要确保能够返回<code>{[Symbol.iterator](): {next: ...}}</code>，当访问<code>Symbol.iterator</code>时就直接返回<code>{next: ...}</code>，可以看到这段代码写的很精妙，为了确保两者都能兼容直接在<code>Symbol.iterator</code>的实现中返回<code>this</code>。为了方便理解我将不必要代码剔除掉，如下：</p>\n<pre><code class=\"language-js\"><span class=\"token keyword\">const</span> keyInterator <span class=\"token operator\">=</span> map<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * keyInterator相当于\n *  {\n *    [Symbol.iterator]() {\n *      return {\n *        next () {\n *          ...\n *        }\n *      }\n *    }\n *  }\n **/</span>\n</code></pre>\n<p>&emsp;&emsp;<code>vue</code>通过特定的<code>method</code>和是否是<code>Map</code>来判断当前需要返回的是键值对还是单值，同时确认好<code>key</code>是使用<code>MAP_KEY_ITERATE_KEY</code>还是<code>ITERATE_KEY</code>，会用使用集合自身的迭代器实现获取结果，然后转化为与当前<code>Proxy</code>类型一致的值返回给用户。</p>\n<p>&emsp;&emsp;到这里我们<code>reactive</code>中具体的实现就已经看完了，这里我们总结一下重要的知识点。</p>\n<h2 id=\"小结\">小结</h2>\n<ul>\n<li><b>创建代理对象的<code>Target</code>必须为对象，不能为基础对象</b></li>\n<li><b><code>reactive</code>类型可以转化为<code>readonly</code>但是不能逆转</b></li>\n<li><b>同一个对象不会创建两次，会在<code>map</code>中查看当前对象是否已经创建，如果创建了直接返回缓存中的</b></li>\n<li><b><code>Proxy</code>对象不能创建原型被冻结的和被<code>mark</code>的对象</b></li>\n<li><b><code>track</code>和<code>trigger</code>需要传入具体细节</b></li>\n<li><b><code>Proxy</code>深入创建时是延迟创建的，在<code>get</code>获取子对象时才会创建子<code>Proxy</code></b></li>\n<li><b><code>readonly</code>在<code>get</code>时不会<code>track</code>属性，因为不可变</b></li>\n<li><b>系统自带的<code>Symbol</code>和保留属性<code>__proto__</code>、<code>__v_isRef</code>、<code>__isVue</code>不会加入<code>track</code>和创建<code>Proxy</code></b></li>\n<li><b><code>Proxy</code>当<code>get</code>到的是<code>ref</code>并且<code>Target</code>不是数组或者是数组但是<code>key</code>不是数组下标时，会自动解包</b></li>\n<li><b>当代理<code>Array</code>时，会修改代理上的<code>indexOf</code>、<code>lastIndexOf</code>、<code>includes</code>、<code>push</code>、<code>pop</code>、<code>unshift</code>、<code>splice</code>方法</b></li>\n<li><b>使用<code>/*#__PURE__*/</code>告诉打包器是纯变量，没使用时可删减减少包体积</b></li>\n<li><b><code>get</code>、<code>has</code>、<code>ownKeys</code>主要职责是<code>track</code></b></li>\n<li><b><code>set</code>、<code>delete</code>主要职责是<code>trigger</code></b></li>\n<li><b>深入创建<code>proxy</code>是在<code>get</code>拦截器进行的</b></li>\n<li><b>因为局限性所以集合类代理是通过修改<code>api</code>来实现的</b></li>\n<li><b>在<code>Proxy</code>获取出来的对象始终是与当前<code>Proxy</code>类型相同的<code>Proxy</code></b></li>\n<li><b>在<code>Proxy</code>存储数据时始终是存储的原始对象</b></li>\n</ul>\n","desc":"阅读准备\n在阅读 reactive 源码之前，我们需要知道它的特性，了解特性推荐阅读单例测试源码或者是阅读官网的 API，推荐阅读单例，在后面阅读时才能更好理解。vue中响应式数据是通过Proxy来实现的，可以通过我之前写的Proxy 和 Reflect来了解它的特性和一些注意事项。\n在vue3中使"}}</script><script>!function(e){function t(t){for(var n,o,i=t[0],c=t[1],l=t[2],s=0,p=[];s<i.length;s++)o=i[s],Object.prototype.hasOwnProperty.call(a,o)&&a[o]&&p.push(a[o][0]),a[o]=0;for(n in c)Object.prototype.hasOwnProperty.call(c,n)&&(e[n]=c[n]);for(f&&f(t);p.length;)p.shift()();return u.push.apply(u,l||[]),r()}function r(){for(var e,t=0;t<u.length;t++){for(var r=u[t],n=!0,o=1;o<r.length;o++){var c=r[o];0!==a[c]&&(n=!1)}n&&(u.splice(t--,1),e=i(i.s=r[0]))}return e}var n={},o={1:0},a={1:0},u=[];function i(t){if(n[t])return n[t].exports;var r=n[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.e=function(e){var t=[];o[e]?t.push(o[e]):0!==o[e]&&{4:1}[e]&&t.push(o[e]=new Promise((function(t,r){for(var n="static/css/"+({}[e]||e)+"."+{3:"31d6cfe0",4:"4422e775"}[e]+".chunk.css",a=i.p+n,u=document.getElementsByTagName("link"),c=0;c<u.length;c++){var l=(f=u[c]).getAttribute("data-href")||f.getAttribute("href");if("stylesheet"===f.rel&&(l===n||l===a))return t()}var s=document.getElementsByTagName("style");for(c=0;c<s.length;c++){var f;if((l=(f=s[c]).getAttribute("data-href"))===n||l===a)return t()}var p=document.createElement("link");p.rel="stylesheet",p.type="text/css",p.onload=t,p.onerror=function(t){var n=t&&t.target&&t.target.src||a,u=new Error("Loading CSS chunk "+e+" failed.\n("+n+")");u.code="CSS_CHUNK_LOAD_FAILED",u.request=n,delete o[e],p.parentNode.removeChild(p),r(u)},p.href=a,document.getElementsByTagName("head")[0].appendChild(p)})).then((function(){o[e]=0})));var r=a[e];if(0!==r)if(r)t.push(r[2]);else{var n=new Promise((function(t,n){r=a[e]=[t,n]}));t.push(r[2]=n);var u,c=document.createElement("script");c.charset="utf-8",c.timeout=120,i.nc&&c.setAttribute("nonce",i.nc),c.src=function(e){return i.p+"static/js/"+({}[e]||e)+"."+{3:"c6f781a0",4:"23b5959c"}[e]+".chunk.js"}(e);var l=new Error;u=function(t){c.onerror=c.onload=null,clearTimeout(s);var r=a[e];if(0!==r){if(r){var n=t&&("load"===t.type?"missing":t.type),o=t&&t.target&&t.target.src;l.message="Loading chunk "+e+" failed.\n("+n+": "+o+")",l.name="ChunkLoadError",l.type=n,l.request=o,r[1](l)}a[e]=void 0}};var s=setTimeout((function(){u({type:"timeout",target:c})}),12e4);c.onerror=c.onload=u,document.head.appendChild(c)}return Promise.all(t)},i.m=e,i.c=n,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i.oe=function(e){throw console.error(e),e};var c=this.webpackJsonpsource=this.webpackJsonpsource||[],l=c.push.bind(c);c.push=t,c=c.slice();for(var s=0;s<c.length;s++)t(c[s]);var f=l;r()}([])</script><script src="/static/js/2.ac4ec11a.chunk.js"></script><script src="/static/js/main.fba0f299.chunk.js"></script></body></html>